<!DOCTYPE html><!DOCTYPE html>

<html lang="zh-CN"><html lang="zh-CN">

<head><head>

  <meta charset="UTF-8" />    <meta charset="UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />    <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Flow Farm 员工客户端</title>    <title>Flow Farm Employee Client</title>

  <link rel="stylesheet" href="styles.css">    <link rel="stylesheet" href="device-styles.css">

</head>    <link rel="stylesheet" href="styles.css">

<body>    <style>

  <!-- 登录界面 -->        * {

  <div id="login-page" class="page">            margin: 0;

    <div class="login-container">            padding: 0;

      <h1>Flow Farm 员工客户端</h1>            box-sizing: border-box;

      <form id="login-form">        }

        <div class="form-group">

          <label for="username">用户名</label>        body {

          <input type="text" id="username" name="username" required>            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;

        </div>            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

        <div class="form-group">            height: 100vh;

          <label for="password">密码</label>            display: flex;

          <input type="password" id="password" name="password" required>            justify-content: center;

        </div>            align-items: center;

        <button type="submit" class="btn-primary">登录</button>        }

        <div id="login-error" class="error-message"></div>

      </form>        .app-container {

    </div>            width: 100%;

  </div>            height: 100%;

            display: flex;

  <!-- 主应用界面 -->            flex-direction: column;

  <div id="app-page" class="page hidden">        }

    <!-- 顶部导航栏 -->

    <nav class="navbar">        /* 登录界面 */

      <div class="navbar-brand">        .login-container {

        <h2>Flow Farm 员工客户端</h2>            background: rgba(255, 255, 255, 0.95);

      </div>            padding: 3rem;

      <div class="navbar-user">            border-radius: 20px;

        <span id="user-info"></span>            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);

        <button id="logout-btn" class="btn-secondary">退出登录</button>            backdrop-filter: blur(10px);

      </div>            border: 1px solid rgba(255, 255, 255, 0.2);

    </nav>            width: 100%;

            max-width: 400px;

    <!-- 侧边栏 -->        }

    <aside class="sidebar">

      <ul class="sidebar-menu">        .login-header {

        <li class="menu-item active" data-page="dashboard">            text-align: center;

          <span class="icon">📊</span>            margin-bottom: 2rem;

          <span>工作台</span>        }

        </li>

        <li class="menu-item" data-page="devices">        .login-header h1 {

          <span class="icon">📱</span>            color: #333;

          <span>设备管理</span>            margin-bottom: 0.5rem;

        </li>            font-size: 2rem;

        <li class="menu-item" data-page="tasks">        }

          <span class="icon">📋</span>

          <span>任务中心</span>        .login-header p {

        </li>            color: #666;

        <li class="menu-item" data-page="xiaohongshu">            font-size: 0.9rem;

          <span class="icon">📕</span>        }

          <span>小红书</span>

        </li>        .form-group {

        <li class="menu-item" data-page="douyin">            margin-bottom: 1.5rem;

          <span class="icon">🎵</span>        }

          <span>抖音</span>

        </li>        .form-group label {

        <li class="menu-item" data-page="statistics">            display: block;

          <span class="icon">📈</span>            margin-bottom: 0.5rem;

          <span>统计数据</span>            color: #333;

        </li>            font-weight: 500;

        <li class="menu-item" data-page="settings">        }

          <span class="icon">⚙️</span>

          <span>设置</span>        .form-group input {

        </li>            width: 100%;

      </ul>            padding: 0.75rem;

    </aside>            border: 2px solid #e1e5e9;

            border-radius: 8px;

    <!-- 主内容区域 -->            font-size: 1rem;

    <main class="main-content">            transition: border-color 0.3s ease;

      <!-- 工作台 -->        }

      <div id="dashboard-view" class="content-view active">

        <h3>工作台概览</h3>        .form-group input:focus {

        <div class="dashboard-cards">            outline: none;

          <div class="stat-card">            border-color: #667eea;

            <h4>已连接设备</h4>        }

            <p class="stat-value" id="connected-devices">0</p>

          </div>        .login-button {

          <div class="stat-card">            width: 100%;

            <h4>今日任务</h4>            padding: 0.75rem;

            <p class="stat-value" id="today-tasks">0</p>            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

          </div>            color: white;

          <div class="stat-card">            border: none;

            <h4>总关注数</h4>            border-radius: 8px;

            <p class="stat-value" id="total-follows">0</p>            font-size: 1rem;

          </div>            font-weight: 600;

          <div class="stat-card">            cursor: pointer;

            <h4>账户余额</h4>            transition: transform 0.2s ease, box-shadow 0.2s ease;

            <p class="stat-value" id="account-balance">¥0.00</p>        }

          </div>

        </div>        .login-button:hover {

      </div>            transform: translateY(-2px);

            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);

      <!-- 设备管理 -->        }

      <div id="devices-view" class="content-view">

        <h3>设备管理 (最多10台)</h3>        .login-button:disabled {

        <div class="device-controls">            background: #ccc;

          <button id="scan-devices-btn" class="btn-primary">扫描设备</button>            cursor: not-allowed;

          <button id="refresh-devices-btn" class="btn-secondary">刷新列表</button>            transform: none;

        </div>            box-shadow: none;

        <div id="devices-list" class="devices-grid"></div>        }

      </div>

        .error-message {

      <!-- 任务中心 -->            color: #e74c3c;

      <div id="tasks-view" class="content-view">            font-size: 0.875rem;

        <h3>任务中心</h3>            margin-top: 0.5rem;

        <div class="task-tabs">            text-align: center;

          <button class="tab-btn active" data-tab="contact">通讯录管理</button>        }

          <button class="tab-btn" data-tab="monitor">精准获客</button>

        </div>        .success-message {

        <div id="task-content" class="task-content"></div>            color: #27ae60;

      </div>            font-size: 0.875rem;

            margin-top: 0.5rem;

      <!-- 小红书自动化 -->            text-align: center;

      <div id="xiaohongshu-view" class="content-view">        }

        <h3>小红书自动化操作</h3>

        <div id="xiaohongshu-content"></div>        .loading {

      </div>            display: inline-block;

            width: 16px;

      <!-- 抖音自动化 -->            height: 16px;

      <div id="douyin-view" class="content-view">            border: 2px solid transparent;

        <h3>抖音自动化操作</h3>            border-top: 2px solid #ffffff;

        <div id="douyin-content">            border-radius: 50%;

          <p class="placeholder">抖音模块开发中...</p>            animation: spin 1s linear infinite;

        </div>            margin-right: 8px;

      </div>        }



      <!-- 统计数据 -->        @keyframes spin {

      <div id="statistics-view" class="content-view">            0% { transform: rotate(0deg); }

        <h3>统计数据</h3>            100% { transform: rotate(360deg); }

        <div id="statistics-content"></div>        }

      </div>

        /* 主应用界面（登录后显示） */

      <!-- 设置 -->        .main-app {

      <div id="settings-view" class="content-view">            display: none;

        <h3>设置</h3>            width: 100%;

        <div id="settings-content">            height: 100%;

          <div class="settings-group">            background: #f5f6fa;

            <h4>服务器配置</h4>        }

            <div class="form-group">

              <label for="server-url">服务器地址</label>        .app-header {

              <input type="text" id="server-url" value="http://localhost:8000">            background: white;

            </div>            padding: 1rem 2rem;

            <button id="save-settings-btn" class="btn-primary">保存设置</button>            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

          </div>            display: flex;

        </div>            justify-content: space-between;

      </div>            align-items: center;

    </main>        }

  </div>

        .app-header h1 {

  <!-- 加载 Tauri API -->            color: #333;

  <script type="module" src="app.js"></script>            font-size: 1.5rem;

</body>        }

</html>

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-name {
            color: #666;
            font-weight: 500;
        }

        .logout-btn {
            padding: 0.5rem 1rem;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .app-content {
            padding: 2rem;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .welcome-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .welcome-section h2 {
            color: #333;
            margin-bottom: 1rem;
        }

        .welcome-section p {
            color: #666;
            line-height: 1.6;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .feature-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .feature-card:hover {
            transform: translateY(-4px);
        }

        .feature-card h3 {
            color: #333;
            margin-bottom: 0.5rem;
        }

        .feature-card p {
            color: #666;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 登录界面 -->
        <div id="login-screen" class="login-container">
            <div class="login-header">
                <h1>Flow Farm</h1>
                <p>员工客户端登录</p>
            </div>

            <form id="login-form">
                <div class="form-group">
                    <label for="username">用户名</label>
                    <input type="text" id="username" name="username" required>
                </div>

                <div class="form-group">
                    <label for="password">密码</label>
                    <input type="password" id="password" name="password" required>
                </div>

                <button type="submit" id="login-btn" class="login-button">
                    登录
                </button>

                <div id="login-message" class="error-message hidden"></div>
            </form>
        </div>

        <!-- 主应用界面 -->
        <div id="main-app" class="main-app">
            <header class="app-header">
                <h1>Flow Farm 员工客户端</h1>
                <div class="user-info">
                    <span id="user-display-name" class="user-name"></span>
                    <button id="logout-btn" class="logout-btn">退出登录</button>
                </div>
            </header>

            <div class="app-content">
                <!-- 导航标签页 -->
                <nav class="nav-tabs">
                    <button class="nav-tab active" data-tab="device-management">设备管理</button>
                    <button class="nav-tab" data-tab="task-management">任务管理</button>
                    <button class="nav-tab" data-tab="statistics">工作统计</button>
                    <button class="nav-tab" data-tab="settings">系统设置</button>
                </nav>

                <!-- 设备管理标签页 -->
                <div id="device-management" class="tab-content active">
                    <div class="page-header">
                        <h2>🔌 设备管理</h2>
                        <div class="header-actions">
                            <button id="refresh-devices-btn" class="btn btn-secondary">
                                <span class="btn-icon">🔄</span>
                                刷新设备
                            </button>
                            <button id="check-adb-btn" class="btn btn-info">
                                <span class="btn-icon">🛠️</span>
                                检查ADB
                            </button>
                        </div>
                    </div>

                    <!-- ADB状态提示 -->
                    <div id="adb-status" class="status-card">
                        <div class="status-indicator">
                            <span class="status-dot status-unknown"></span>
                            <span class="status-text">检查ADB连接状态...</span>
                        </div>
                        <!-- ADB路径配置区域 -->
                        <div id="adb-config" class="adb-config">
                            <div class="config-row">
                                <label for="adb-path-input">ADB路径:</label>
                                <input type="text" id="adb-path-input" placeholder="请输入ADB程序完整路径，如：D:\leidian\LDPlayer9\adb.exe">
                                <button class="btn btn-primary" onclick="setAdbPath()">设置</button>
                            </div>
                            <div class="config-row">
                                <button class="btn btn-info" onclick="findAdbInstallations()">自动搜索ADB</button>
                                <small class="config-help-text">搜索常见模拟器和SDK中的ADB程序</small>
                            </div>
                        </div>
                    </div>

                    <!-- 设备列表 -->
                    <div class="devices-section">
                        <div class="section-header">
                            <h3>连接的设备 (<span id="device-count">0</span>/10)</h3>
                            <div class="device-stats">
                                <span class="stat-item">
                                    <span class="stat-label">可用:</span>
                                    <span id="available-count" class="stat-value">0</span>
                                </span>
                                <span class="stat-item">
                                    <span class="stat-label">已连接:</span>
                                    <span id="connected-count" class="stat-value">0</span>
                                </span>
                            </div>
                        </div>

                        <div id="devices-grid" class="devices-grid">
                            <!-- 设备卡片将在这里动态生成 -->
                        </div>

                        <div id="no-devices" class="empty-state">
                            <div class="empty-icon">📱</div>
                            <h3>未检测到设备</h3>
                            <p>请确保设备已连接并开启USB调试模式</p>
                            <button id="scan-devices-btn" class="btn btn-primary">
                                <span class="btn-icon">🔍</span>
                                扫描设备
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 任务管理标签页 -->
                <div id="task-management" class="tab-content">
                    <div class="page-header">
                        <h2>📋 任务管理</h2>
                    </div>
                    <div class="placeholder-content">
                        <p>任务管理功能正在开发中...</p>
                    </div>
                </div>

                <!-- 统计标签页 -->
                <div id="statistics" class="tab-content">
                    <div class="page-header">
                        <h2>📊 工作统计</h2>
                    </div>
                    <div class="placeholder-content">
                        <p>工作统计功能正在开发中...</p>
                    </div>
                </div>

                <!-- 设置标签页 -->
                <div id="settings" class="tab-content">
                    <div class="page-header">
                        <h2>⚙️ 系统设置</h2>
                    </div>
                    <div class="placeholder-content">
                        <p>系统设置功能正在开发中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 等待Tauri API准备就绪
        let invoke;

        async function initializeTauri() {
            try {
                // 检查Tauri是否可用
                if (typeof window.__TAURI__ === 'undefined') {
                    console.error('Tauri API 未加载');
                    throw new Error('Tauri API 未加载');
                }

                console.log('Tauri 对象结构:', Object.keys(window.__TAURI__));

                // 尝试不同的API访问方式
                if (window.__TAURI__.invoke) {
                    // Tauri 1.x 风格
                    invoke = window.__TAURI__.invoke;
                    console.log('使用 Tauri 1.x API 风格');
                } else if (window.__TAURI__.tauri && window.__TAURI__.tauri.invoke) {
                    // Tauri 2.x 风格
                    invoke = window.__TAURI__.tauri.invoke;
                    console.log('使用 Tauri 2.x API 风格');
                } else if (window.__TAURI__.core && window.__TAURI__.core.invoke) {
                    // 另一种可能的结构
                    invoke = window.__TAURI__.core.invoke;
                    console.log('使用 Tauri core API 风格');
                } else {
                    console.error('未找到 invoke 函数，可用的属性:', Object.keys(window.__TAURI__));
                    throw new Error('未找到 invoke 函数');
                }

                console.log('Tauri API 初始化成功');
                return true;
            } catch (error) {
                console.error('Tauri API 初始化失败:', error);
                return false;
            }
        }

        // DOM 元素
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const loginBtn = document.getElementById('login-btn');
        const loginMessage = document.getElementById('login-message');
        const userDisplayName = document.getElementById('user-display-name');
        const logoutBtn = document.getElementById('logout-btn');

        // 设备管理相关的DOM元素
        let devicesGridEl, deviceCountEl, availableCountEl, connectedCountEl, noDevicesEl, adbStatusEl;
        let currentDevices = [];
        let connectedDevicesMap = new Map(); // 存储已连接设备的状态

        // 初始化设备管理DOM元素
        function initializeDeviceManagementElements() {
            try {
                devicesGridEl = document.getElementById('devices-grid');
                deviceCountEl = document.getElementById('device-count');
                availableCountEl = document.getElementById('available-count');
                connectedCountEl = document.getElementById('connected-count');
                noDevicesEl = document.getElementById('no-devices');
                adbStatusEl = document.getElementById('adb-status');

                console.log('设备管理DOM元素初始化:', {
                    devicesGridEl: !!devicesGridEl,
                    deviceCountEl: !!deviceCountEl,
                    availableCountEl: !!availableCountEl,
                    connectedCountEl: !!connectedCountEl,
                    noDevicesEl: !!noDevicesEl,
                    adbStatusEl: !!adbStatusEl
                });

                // 绑定事件
                const refreshBtn = document.getElementById('refresh-devices-btn');
                const checkAdbBtn = document.getElementById('check-adb-btn');
                const scanBtn = document.getElementById('scan-devices-btn');

                if (refreshBtn) refreshBtn.addEventListener('click', refreshDevices);
                if (checkAdbBtn) checkAdbBtn.addEventListener('click', checkAdbStatus);
                if (scanBtn) scanBtn.addEventListener('click', refreshDevices);

                // 绑定标签页切换
                const navTabs = document.querySelectorAll('.nav-tab');
                console.log('找到导航标签页数量:', navTabs.length);
                navTabs.forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const tabId = e.target.dataset.tab;
                        console.log('切换到标签页:', tabId);
                        switchTab(tabId);
                    });
                });
            } catch (error) {
                console.error('初始化设备管理元素失败:', error);
            }
        }

        // 应用初始化
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM 加载完成，开始应用初始化...');

            // 首先初始化Tauri API
            const tauriReady = await initializeTauri();
            if (!tauriReady) {
                showMessage('应用初始化失败，请重新启动应用', 'error');
                return;
            }

            try {
                // 检查是否已登录
                const isLoggedIn = await invoke('is_logged_in');
                console.log('登录状态检查:', isLoggedIn);

                if (isLoggedIn) {
                    const currentUser = await invoke('get_current_user');
                    console.log('当前用户:', currentUser);
                    if (currentUser) {
                        console.log('显示主应用界面');
                        showMainApp(currentUser);
                        return;
                    } else {
                        console.log('用户信息为空，显示登录界面');
                    }
                } else {
                    console.log('未登录，显示登录界面');
                }
            } catch (error) {
                console.error('初始化检查登录状态失败:', error);
            }

            // 显示登录界面
            showLoginScreen();
        });

        // 登录表单提交
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!username || !password) {
                showMessage('请输入用户名和密码', 'error');
                return;
            }

            setLoading(true);
            hideMessage();

            try {
                console.log('尝试登录:', username);
                console.log('Tauri API 可用:', typeof window.__TAURI__ !== 'undefined');
                console.log('invoke 函数可用:', typeof invoke === 'function');

                if (!invoke) {
                    throw new Error('Tauri API 未初始化');
                }

                const session = await invoke('login', { username, password });
                console.log('登录成功:', session);

                showMessage('登录成功！', 'success');
                setTimeout(() => {
                    showMainApp(session.user);
                }, 1000);

            } catch (error) {
                console.error('登录失败详细信息:', error);
                console.error('错误类型:', typeof error);
                console.error('错误JSON:', JSON.stringify(error));

                let errorMessage;
                if (typeof error === 'object' && error.message) {
                    errorMessage = error.message;
                } else if (typeof error === 'string') {
                    errorMessage = error;
                } else {
                    errorMessage = '登录失败，请检查用户名和密码';
                }

                showMessage(errorMessage, 'error');
            } finally {
                setLoading(false);
            }
        });

        // 退出登录
        logoutBtn.addEventListener('click', async () => {
            try {
                await invoke('logout');
                console.log('已退出登录');
                showLoginScreen();
            } catch (error) {
                console.error('退出登录失败:', error);
            }
        });

        // 显示登录界面
        function showLoginScreen() {
            console.log('showLoginScreen 被调用');
            loginScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');

            // 清空登录表单
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            hideMessage();
        }

        // 显示主应用界面
        function showMainApp(user) {
            console.log('showMainApp 被调用，用户数据:', user);

            if (!user) {
                console.error('用户数据为空');
                showMessage('用户数据获取失败', 'error');
                showLoginScreen();
                return;
            }

            loginScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');

            // 显示用户信息
            const displayName = user.full_name || user.username;
            console.log('设置显示名称:', displayName);
            if (userDisplayName) {
                userDisplayName.textContent = `${displayName} (${user.role})`;
            }

            console.log('主应用界面应该现在可见了');
            console.log('loginScreen hidden:', loginScreen.classList.contains('hidden'));
            console.log('mainApp hidden:', mainApp.classList.contains('hidden'));

            // 初始化设备管理
            initializeDeviceManagementElements();

            // 延迟执行设备检查，确保DOM已渲染
            setTimeout(() => {
                console.log('开始执行设备状态检查和刷新...');
                checkAdbStatus();
                refreshDevices();
            }, 500);
        }

        // ========== 设备管理功能 ==========

        // 标签页切换
        function switchTab(tabId) {
            try {
                console.log('切换标签页到:', tabId);

                // 切换标签页按钮状态
                const navTabs = document.querySelectorAll('.nav-tab');
                navTabs.forEach(tab => {
                    tab.classList.remove('active');
                });

                const activeTab = document.querySelector(`[data-tab="${tabId}"]`);
                if (activeTab) {
                    activeTab.classList.add('active');
                    console.log('激活标签页按钮:', tabId);
                } else {
                    console.warn('未找到标签页按钮:', tabId);
                }

                // 切换标签页内容
                const tabContents = document.querySelectorAll('.tab-content');
                tabContents.forEach(content => {
                    content.classList.remove('active');
                });

                const activeContent = document.getElementById(tabId);
                if (activeContent) {
                    activeContent.classList.add('active');
                    console.log('显示标签页内容:', tabId);
                } else {
                    console.warn('未找到标签页内容:', tabId);
                }
            } catch (error) {
                console.error('切换标签页失败:', error);
            }
        }

        // 检查ADB状态
        async function checkAdbStatus() {
            try {
                updateAdbStatus('检查ADB连接状态...', 'unknown');

                const isAvailable = await invoke('check_adb_available');

                if (isAvailable) {
                    updateAdbStatus('ADB连接正常', 'online');
                    hideAdbConfig();
                } else {
                    updateAdbStatus('ADB未安装或不可用 - 请配置ADB路径', 'offline');
                    showAdbConfig();
                }

                return isAvailable;
            } catch (error) {
                console.error('检查ADB状态失败:', error);
                updateAdbStatus('ADB状态检查失败 - 请配置ADB路径', 'offline');
                showAdbConfig();
                return false;
            }
        }

        // 显示ADB配置区域
        function showAdbConfig() {
            const configEl = document.getElementById('adb-config');
            if (configEl) {
                configEl.classList.remove('hidden');
            }
        }

        // 隐藏ADB配置区域
        function hideAdbConfig() {
            const configEl = document.getElementById('adb-config');
            if (configEl) {
                configEl.classList.add('hidden');
            }
        }

        // 设置ADB路径
        async function setAdbPath() {
            const pathInput = document.getElementById('adb-path-input');
            const adbPath = pathInput.value.trim();

            if (!adbPath) {
                showNotification('请输入ADB路径', 'error');
                return;
            }

            try {
                showNotification('正在验证ADB路径...', 'info');

                const isValid = await invoke('set_adb_path', { adbPath });

                if (isValid) {
                    showNotification('ADB路径设置成功！', 'success');
                    // 重新检查ADB状态
                    setTimeout(() => {
                        checkAdbStatus();
                    }, 1000);
                } else {
                    showNotification('ADB路径无效', 'error');
                }
            } catch (error) {
                console.error('设置ADB路径失败:', error);
                showNotification('ADB路径设置失败: ' + error, 'error');
            }
        }

        // 自动搜索ADB安装
        async function findAdbInstallations() {
            try {
                showNotification('正在搜索ADB程序...', 'info');

                const foundPaths = await invoke('find_adb_installations');

                if (foundPaths.length > 0) {
                    // 自动选择第一个找到的路径
                    const pathInput = document.getElementById('adb-path-input');
                    pathInput.value = foundPaths[0];

                    showNotification(`找到 ${foundPaths.length} 个ADB程序，已自动选择第一个`, 'success');

                    // 如果找到了路径，提示用户可以点击设置
                    setTimeout(() => {
                        showNotification('请点击"设置"按钮应用ADB路径', 'info');
                    }, 2000);
                } else {
                    showNotification('未找到ADB程序，请手动输入路径', 'info');
                }
            } catch (error) {
                console.error('搜索ADB安装失败:', error);
                showNotification('搜索ADB安装失败: ' + error, 'error');
            }
        }

        // 更新ADB状态显示
        function updateAdbStatus(message, status) {
            if (!adbStatusEl) return;

            const indicator = adbStatusEl.querySelector('.status-indicator');
            const dot = indicator.querySelector('.status-dot');
            const text = indicator.querySelector('.status-text');

            dot.className = `status-dot status-${status}`;
            text.textContent = message;
        }

        // 刷新设备列表
        async function refreshDevices() {
            try {
                console.log('开始刷新设备列表');

                // 检查ADB是否可用
                const adbAvailable = await checkAdbStatus();
                if (!adbAvailable) {
                    showNotification('ADB不可用，请检查ADB安装', 'error');
                    updateDevicesList([]);
                    return;
                }

                showNotification('正在扫描设备...', 'info');

                const devices = await invoke('get_adb_devices');
                console.log('获取到的设备列表:', devices);

                // 确保devices是一个数组
                const deviceList = Array.isArray(devices) ? devices : [];
                currentDevices = deviceList;
                updateDevicesList(currentDevices);

                if (deviceList.length > 0) {
                    showNotification(`发现 ${deviceList.length} 个设备`, 'success');
                } else {
                    showNotification('未发现任何设备', 'info');
                }

            } catch (error) {
                console.error('刷新设备列表失败:', error);
                showNotification('设备扫描失败: ' + (error.message || error), 'error');
                updateDevicesList([]);
            }
        }

        // 更新设备列表显示
        function updateDevicesList(devices) {
            if (!devicesGridEl || !deviceCountEl || !availableCountEl || !connectedCountEl || !noDevicesEl) {
                console.warn('设备管理元素未初始化');
                return;
            }

            // 确保devices是一个数组
            const validDevices = Array.isArray(devices) ? devices : [];
            const deviceCount = validDevices.length;
            const availableDevices = validDevices.filter(d => d && (d.status === 'device' || d.status === 'available'));
            const connectedDevices = validDevices.filter(d => d && connectedDevicesMap.has(d.id));

            // 更新统计数字
            deviceCountEl.textContent = deviceCount;
            availableCountEl.textContent = availableDevices.length;
            connectedCountEl.textContent = connectedDevices.length;

            // 清空设备网格
            devicesGridEl.innerHTML = '';

            if (deviceCount === 0) {
                // 显示空状态
                noDevicesEl.classList.remove('hidden');
                noDevicesEl.classList.add('show-block');
                devicesGridEl.classList.add('hidden');
                devicesGridEl.classList.remove('show-grid');
            } else {
                // 隐藏空状态，显示设备网格
                noDevicesEl.classList.add('hidden');
                noDevicesEl.classList.remove('show-block');
                devicesGridEl.classList.remove('hidden');
                devicesGridEl.classList.add('show-grid');

                // 生成设备卡片
                validDevices.forEach((device, index) => {
                    if (device && index < 10) { // 最多显示10个设备
                        try {
                            const deviceCard = createDeviceCard(device, index + 1);
                            devicesGridEl.appendChild(deviceCard);
                        } catch (error) {
                            console.error('创建设备卡片失败:', error, device);
                        }
                    }
                });
            }
        }

        // 创建设备卡片
        function createDeviceCard(device, slotNumber) {
            if (!device || !device.id) {
                console.error('无效的设备数据:', device);
                return document.createElement('div');
            }

            const isConnected = connectedDevicesMap.has(device.id);
            const isAvailable = device.status === 'device';

            const card = document.createElement('div');
            card.className = `device-card ${isConnected ? 'connected' : ''} ${!isAvailable ? 'offline' : ''}`;
            card.dataset.deviceId = device.id;

            // 获取设备状态和样式
            let statusText, statusClass;
            if (isConnected) {
                statusText = '已连接';
                statusClass = 'connected';
            } else if (isAvailable) {
                statusText = '可连接';
                statusClass = 'available';
            } else if (device.status === 'unauthorized') {
                statusText = '未授权';
                statusClass = 'unauthorized';
            } else {
                statusText = '离线';
                statusClass = 'offline';
            }

            card.innerHTML = `
                <div class="device-header">
                    <div class="device-name">设备 ${slotNumber}</div>
                    <div class="device-status ${statusClass}">${statusText}</div>
                </div>
                <div class="device-info">
                    <div class="device-info-row">
                        <span class="device-info-label">设备ID:</span>
                        <span class="device-info-value">${device.id || '未知'}</span>
                    </div>
                    <div class="device-info-row">
                        <span class="device-info-label">型号:</span>
                        <span class="device-info-value">${device.model || '未知'}</span>
                    </div>
                    <div class="device-info-row">
                        <span class="device-info-label">Android版本:</span>
                        <span class="device-info-value">${device.android_version || '未知'}</span>
                    </div>
                    ${device.battery_level ? `
                    <div class="device-info-row">
                        <span class="device-info-label">电量:</span>
                        <span class="device-info-value">${device.battery_level}%</span>
                    </div>
                    ` : ''}
                </div>
                <div class="device-actions">
                    ${getDeviceActionButton(device, isConnected, isAvailable)}
                    <button class="btn btn-info" onclick="showDeviceInfo('${device.id}')">详情</button>
                </div>
            `;

            return card;
        }

        // 获取设备操作按钮
        function getDeviceActionButton(device, isConnected, isAvailable) {
            if (isConnected) {
                return `<button class="btn btn-danger" onclick="disconnectDevice('${device.id}')">断开连接</button>`;
            } else if (isAvailable) {
                return `<button class="btn btn-success" onclick="connectDevice('${device.id}')">连接</button>`;
            } else {
                return `<button class="btn btn-secondary" disabled>不可用</button>`;
            }
        }

        // 连接设备
        async function connectDevice(deviceId) {
            try {
                showNotification('正在连接设备...', 'info');

                const device = await invoke('connect_adb_device', { deviceId });
                console.log('设备连接成功:', device);

                // 更新连接状态
                connectedDevicesMap.set(deviceId, device);

                // 刷新设备列表显示
                updateDevicesList(currentDevices);

                showNotification('设备连接成功', 'success');

            } catch (error) {
                console.error('连接设备失败:', error);
                showNotification('设备连接失败: ' + error, 'error');
            }
        }

        // 断开设备连接
        async function disconnectDevice(deviceId) {
            try {
                showNotification('正在断开设备...', 'info');

                await invoke('disconnect_adb_device', { deviceId });
                console.log('设备断开成功:', deviceId);

                // 更新连接状态
                connectedDevicesMap.delete(deviceId);

                // 刷新设备列表显示
                updateDevicesList(currentDevices);

                showNotification('设备断开成功', 'success');

            } catch (error) {
                console.error('断开设备失败:', error);
                showNotification('设备断开失败: ' + error, 'error');
            }
        }

        // 显示设备详细信息
        async function showDeviceInfo(deviceId) {
            try {
                const device = await invoke('get_device_info', { deviceId });

                if (device) {
                    alert(`设备详细信息:\n\n设备ID: ${device.id}\n名称: ${device.name}\n型号: ${device.model || '未知'}\n制造商: ${device.manufacturer || '未知'}\nAndroid版本: ${device.android_version || '未知'}\n屏幕分辨率: ${device.screen_resolution || '未知'}\n电量: ${device.battery_level ? device.battery_level + '%' : '未知'}\n状态: ${device.status}\n最后检测时间: ${new Date(device.last_seen).toLocaleString()}`);
                } else {
                    showNotification('获取设备信息失败', 'error');
                }

            } catch (error) {
                console.error('获取设备信息失败:', error);
                showNotification('获取设备信息失败: ' + error, 'error');
            }
        }

        // 显示通知
        function showNotification(message, type = 'info', duration = 3000) {
            // 移除已存在的通知
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // 创建新通知
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            document.body.appendChild(notification);

            // 自动移除通知
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, duration);
        }

        // 将函数暴露到全局作用域，供HTML中的onclick使用
        window.connectDevice = connectDevice;
        window.disconnectDevice = disconnectDevice;
        window.showDeviceInfo = showDeviceInfo;
        window.setAdbPath = setAdbPath;
        window.findAdbInstallations = findAdbInstallations;

        // 设置加载状态
        function setLoading(loading) {
            const loginBtn = document.getElementById('login-btn');

            if (loading) {
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<span class="loading"></span>登录中...';
            } else {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '登录';
            }
        }

        // 显示消息
        function showMessage(message, type = 'error') {
            const messageEl = document.getElementById('login-message');
            messageEl.textContent = message;
            messageEl.className = type === 'error' ? 'error-message' : 'success-message';
            messageEl.classList.remove('hidden');
        }

        // 隐藏消息
        function hideMessage() {
            const messageEl = document.getElementById('login-message');
            messageEl.classList.add('hidden');
        }

        // 全局错误处理
        window.addEventListener('unhandledrejection', (event) => {
            console.error('未处理的Promise拒绝:', event.reason);
            showMessage('系统错误，请稍后重试', 'error');
        });

        window.addEventListener('error', (event) => {
            console.error('全局错误:', event.error);
            showMessage('系统错误，请稍后重试', 'error');
        });
    </script>
</body>
</html>
