<!DOCTYPE html><!DOCTYPE html>

<html lang="zh-CN"><html lang="zh-CN">

<head><head>

  <meta charset="UTF-8" />    <meta charset="UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />    <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Flow Farm å‘˜å·¥å®¢æˆ·ç«¯</title>    <title>Flow Farm Employee Client</title>

  <link rel="stylesheet" href="styles.css">    <link rel="stylesheet" href="device-styles.css">

</head>    <link rel="stylesheet" href="styles.css">

<body>    <style>

  <!-- ç™»å½•ç•Œé¢ -->        * {

  <div id="login-page" class="page">            margin: 0;

    <div class="login-container">            padding: 0;

      <h1>Flow Farm å‘˜å·¥å®¢æˆ·ç«¯</h1>            box-sizing: border-box;

      <form id="login-form">        }

        <div class="form-group">

          <label for="username">ç”¨æˆ·å</label>        body {

          <input type="text" id="username" name="username" required>            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;

        </div>            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

        <div class="form-group">            height: 100vh;

          <label for="password">å¯†ç </label>            display: flex;

          <input type="password" id="password" name="password" required>            justify-content: center;

        </div>            align-items: center;

        <button type="submit" class="btn-primary">ç™»å½•</button>        }

        <div id="login-error" class="error-message"></div>

      </form>        .app-container {

    </div>            width: 100%;

  </div>            height: 100%;

            display: flex;

  <!-- ä¸»åº”ç”¨ç•Œé¢ -->            flex-direction: column;

  <div id="app-page" class="page hidden">        }

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->

    <nav class="navbar">        /* ç™»å½•ç•Œé¢ */

      <div class="navbar-brand">        .login-container {

        <h2>Flow Farm å‘˜å·¥å®¢æˆ·ç«¯</h2>            background: rgba(255, 255, 255, 0.95);

      </div>            padding: 3rem;

      <div class="navbar-user">            border-radius: 20px;

        <span id="user-info"></span>            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);

        <button id="logout-btn" class="btn-secondary">é€€å‡ºç™»å½•</button>            backdrop-filter: blur(10px);

      </div>            border: 1px solid rgba(255, 255, 255, 0.2);

    </nav>            width: 100%;

            max-width: 400px;

    <!-- ä¾§è¾¹æ  -->        }

    <aside class="sidebar">

      <ul class="sidebar-menu">        .login-header {

        <li class="menu-item active" data-page="dashboard">            text-align: center;

          <span class="icon">ğŸ“Š</span>            margin-bottom: 2rem;

          <span>å·¥ä½œå°</span>        }

        </li>

        <li class="menu-item" data-page="devices">        .login-header h1 {

          <span class="icon">ğŸ“±</span>            color: #333;

          <span>è®¾å¤‡ç®¡ç†</span>            margin-bottom: 0.5rem;

        </li>            font-size: 2rem;

        <li class="menu-item" data-page="tasks">        }

          <span class="icon">ğŸ“‹</span>

          <span>ä»»åŠ¡ä¸­å¿ƒ</span>        .login-header p {

        </li>            color: #666;

        <li class="menu-item" data-page="xiaohongshu">            font-size: 0.9rem;

          <span class="icon">ğŸ“•</span>        }

          <span>å°çº¢ä¹¦</span>

        </li>        .form-group {

        <li class="menu-item" data-page="douyin">            margin-bottom: 1.5rem;

          <span class="icon">ğŸµ</span>        }

          <span>æŠ–éŸ³</span>

        </li>        .form-group label {

        <li class="menu-item" data-page="statistics">            display: block;

          <span class="icon">ğŸ“ˆ</span>            margin-bottom: 0.5rem;

          <span>ç»Ÿè®¡æ•°æ®</span>            color: #333;

        </li>            font-weight: 500;

        <li class="menu-item" data-page="settings">        }

          <span class="icon">âš™ï¸</span>

          <span>è®¾ç½®</span>        .form-group input {

        </li>            width: 100%;

      </ul>            padding: 0.75rem;

    </aside>            border: 2px solid #e1e5e9;

            border-radius: 8px;

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->            font-size: 1rem;

    <main class="main-content">            transition: border-color 0.3s ease;

      <!-- å·¥ä½œå° -->        }

      <div id="dashboard-view" class="content-view active">

        <h3>å·¥ä½œå°æ¦‚è§ˆ</h3>        .form-group input:focus {

        <div class="dashboard-cards">            outline: none;

          <div class="stat-card">            border-color: #667eea;

            <h4>å·²è¿æ¥è®¾å¤‡</h4>        }

            <p class="stat-value" id="connected-devices">0</p>

          </div>        .login-button {

          <div class="stat-card">            width: 100%;

            <h4>ä»Šæ—¥ä»»åŠ¡</h4>            padding: 0.75rem;

            <p class="stat-value" id="today-tasks">0</p>            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

          </div>            color: white;

          <div class="stat-card">            border: none;

            <h4>æ€»å…³æ³¨æ•°</h4>            border-radius: 8px;

            <p class="stat-value" id="total-follows">0</p>            font-size: 1rem;

          </div>            font-weight: 600;

          <div class="stat-card">            cursor: pointer;

            <h4>è´¦æˆ·ä½™é¢</h4>            transition: transform 0.2s ease, box-shadow 0.2s ease;

            <p class="stat-value" id="account-balance">Â¥0.00</p>        }

          </div>

        </div>        .login-button:hover {

      </div>            transform: translateY(-2px);

            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);

      <!-- è®¾å¤‡ç®¡ç† -->        }

      <div id="devices-view" class="content-view">

        <h3>è®¾å¤‡ç®¡ç† (æœ€å¤š10å°)</h3>        .login-button:disabled {

        <div class="device-controls">            background: #ccc;

          <button id="scan-devices-btn" class="btn-primary">æ‰«æè®¾å¤‡</button>            cursor: not-allowed;

          <button id="refresh-devices-btn" class="btn-secondary">åˆ·æ–°åˆ—è¡¨</button>            transform: none;

        </div>            box-shadow: none;

        <div id="devices-list" class="devices-grid"></div>        }

      </div>

        .error-message {

      <!-- ä»»åŠ¡ä¸­å¿ƒ -->            color: #e74c3c;

      <div id="tasks-view" class="content-view">            font-size: 0.875rem;

        <h3>ä»»åŠ¡ä¸­å¿ƒ</h3>            margin-top: 0.5rem;

        <div class="task-tabs">            text-align: center;

          <button class="tab-btn active" data-tab="contact">é€šè®¯å½•ç®¡ç†</button>        }

          <button class="tab-btn" data-tab="monitor">ç²¾å‡†è·å®¢</button>

        </div>        .success-message {

        <div id="task-content" class="task-content"></div>            color: #27ae60;

      </div>            font-size: 0.875rem;

            margin-top: 0.5rem;

      <!-- å°çº¢ä¹¦è‡ªåŠ¨åŒ– -->            text-align: center;

      <div id="xiaohongshu-view" class="content-view">        }

        <h3>å°çº¢ä¹¦è‡ªåŠ¨åŒ–æ“ä½œ</h3>

        <div id="xiaohongshu-content"></div>        .loading {

      </div>            display: inline-block;

            width: 16px;

      <!-- æŠ–éŸ³è‡ªåŠ¨åŒ– -->            height: 16px;

      <div id="douyin-view" class="content-view">            border: 2px solid transparent;

        <h3>æŠ–éŸ³è‡ªåŠ¨åŒ–æ“ä½œ</h3>            border-top: 2px solid #ffffff;

        <div id="douyin-content">            border-radius: 50%;

          <p class="placeholder">æŠ–éŸ³æ¨¡å—å¼€å‘ä¸­...</p>            animation: spin 1s linear infinite;

        </div>            margin-right: 8px;

      </div>        }



      <!-- ç»Ÿè®¡æ•°æ® -->        @keyframes spin {

      <div id="statistics-view" class="content-view">            0% { transform: rotate(0deg); }

        <h3>ç»Ÿè®¡æ•°æ®</h3>            100% { transform: rotate(360deg); }

        <div id="statistics-content"></div>        }

      </div>

        /* ä¸»åº”ç”¨ç•Œé¢ï¼ˆç™»å½•åæ˜¾ç¤ºï¼‰ */

      <!-- è®¾ç½® -->        .main-app {

      <div id="settings-view" class="content-view">            display: none;

        <h3>è®¾ç½®</h3>            width: 100%;

        <div id="settings-content">            height: 100%;

          <div class="settings-group">            background: #f5f6fa;

            <h4>æœåŠ¡å™¨é…ç½®</h4>        }

            <div class="form-group">

              <label for="server-url">æœåŠ¡å™¨åœ°å€</label>        .app-header {

              <input type="text" id="server-url" value="http://localhost:8000">            background: white;

            </div>            padding: 1rem 2rem;

            <button id="save-settings-btn" class="btn-primary">ä¿å­˜è®¾ç½®</button>            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

          </div>            display: flex;

        </div>            justify-content: space-between;

      </div>            align-items: center;

    </main>        }

  </div>

        .app-header h1 {

  <!-- åŠ è½½ Tauri API -->            color: #333;

  <script type="module" src="app.js"></script>            font-size: 1.5rem;

</body>        }

</html>

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-name {
            color: #666;
            font-weight: 500;
        }

        .logout-btn {
            padding: 0.5rem 1rem;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .app-content {
            padding: 2rem;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .welcome-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .welcome-section h2 {
            color: #333;
            margin-bottom: 1rem;
        }

        .welcome-section p {
            color: #666;
            line-height: 1.6;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .feature-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .feature-card:hover {
            transform: translateY(-4px);
        }

        .feature-card h3 {
            color: #333;
            margin-bottom: 0.5rem;
        }

        .feature-card p {
            color: #666;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ç™»å½•ç•Œé¢ -->
        <div id="login-screen" class="login-container">
            <div class="login-header">
                <h1>Flow Farm</h1>
                <p>å‘˜å·¥å®¢æˆ·ç«¯ç™»å½•</p>
            </div>

            <form id="login-form">
                <div class="form-group">
                    <label for="username">ç”¨æˆ·å</label>
                    <input type="text" id="username" name="username" required>
                </div>

                <div class="form-group">
                    <label for="password">å¯†ç </label>
                    <input type="password" id="password" name="password" required>
                </div>

                <button type="submit" id="login-btn" class="login-button">
                    ç™»å½•
                </button>

                <div id="login-message" class="error-message hidden"></div>
            </form>
        </div>

        <!-- ä¸»åº”ç”¨ç•Œé¢ -->
        <div id="main-app" class="main-app">
            <header class="app-header">
                <h1>Flow Farm å‘˜å·¥å®¢æˆ·ç«¯</h1>
                <div class="user-info">
                    <span id="user-display-name" class="user-name"></span>
                    <button id="logout-btn" class="logout-btn">é€€å‡ºç™»å½•</button>
                </div>
            </header>

            <div class="app-content">
                <!-- å¯¼èˆªæ ‡ç­¾é¡µ -->
                <nav class="nav-tabs">
                    <button class="nav-tab active" data-tab="device-management">è®¾å¤‡ç®¡ç†</button>
                    <button class="nav-tab" data-tab="task-management">ä»»åŠ¡ç®¡ç†</button>
                    <button class="nav-tab" data-tab="statistics">å·¥ä½œç»Ÿè®¡</button>
                    <button class="nav-tab" data-tab="settings">ç³»ç»Ÿè®¾ç½®</button>
                </nav>

                <!-- è®¾å¤‡ç®¡ç†æ ‡ç­¾é¡µ -->
                <div id="device-management" class="tab-content active">
                    <div class="page-header">
                        <h2>ğŸ”Œ è®¾å¤‡ç®¡ç†</h2>
                        <div class="header-actions">
                            <button id="refresh-devices-btn" class="btn btn-secondary">
                                <span class="btn-icon">ğŸ”„</span>
                                åˆ·æ–°è®¾å¤‡
                            </button>
                            <button id="check-adb-btn" class="btn btn-info">
                                <span class="btn-icon">ğŸ› ï¸</span>
                                æ£€æŸ¥ADB
                            </button>
                        </div>
                    </div>

                    <!-- ADBçŠ¶æ€æç¤º -->
                    <div id="adb-status" class="status-card">
                        <div class="status-indicator">
                            <span class="status-dot status-unknown"></span>
                            <span class="status-text">æ£€æŸ¥ADBè¿æ¥çŠ¶æ€...</span>
                        </div>
                        <!-- ADBè·¯å¾„é…ç½®åŒºåŸŸ -->
                        <div id="adb-config" class="adb-config">
                            <div class="config-row">
                                <label for="adb-path-input">ADBè·¯å¾„:</label>
                                <input type="text" id="adb-path-input" placeholder="è¯·è¾“å…¥ADBç¨‹åºå®Œæ•´è·¯å¾„ï¼Œå¦‚ï¼šD:\leidian\LDPlayer9\adb.exe">
                                <button class="btn btn-primary" onclick="setAdbPath()">è®¾ç½®</button>
                            </div>
                            <div class="config-row">
                                <button class="btn btn-info" onclick="findAdbInstallations()">è‡ªåŠ¨æœç´¢ADB</button>
                                <small class="config-help-text">æœç´¢å¸¸è§æ¨¡æ‹Ÿå™¨å’ŒSDKä¸­çš„ADBç¨‹åº</small>
                            </div>
                        </div>
                    </div>

                    <!-- è®¾å¤‡åˆ—è¡¨ -->
                    <div class="devices-section">
                        <div class="section-header">
                            <h3>è¿æ¥çš„è®¾å¤‡ (<span id="device-count">0</span>/10)</h3>
                            <div class="device-stats">
                                <span class="stat-item">
                                    <span class="stat-label">å¯ç”¨:</span>
                                    <span id="available-count" class="stat-value">0</span>
                                </span>
                                <span class="stat-item">
                                    <span class="stat-label">å·²è¿æ¥:</span>
                                    <span id="connected-count" class="stat-value">0</span>
                                </span>
                            </div>
                        </div>

                        <div id="devices-grid" class="devices-grid">
                            <!-- è®¾å¤‡å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>

                        <div id="no-devices" class="empty-state">
                            <div class="empty-icon">ğŸ“±</div>
                            <h3>æœªæ£€æµ‹åˆ°è®¾å¤‡</h3>
                            <p>è¯·ç¡®ä¿è®¾å¤‡å·²è¿æ¥å¹¶å¼€å¯USBè°ƒè¯•æ¨¡å¼</p>
                            <button id="scan-devices-btn" class="btn btn-primary">
                                <span class="btn-icon">ğŸ”</span>
                                æ‰«æè®¾å¤‡
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ä»»åŠ¡ç®¡ç†æ ‡ç­¾é¡µ -->
                <div id="task-management" class="tab-content">
                    <div class="page-header">
                        <h2>ğŸ“‹ ä»»åŠ¡ç®¡ç†</h2>
                    </div>
                    <div class="placeholder-content">
                        <p>ä»»åŠ¡ç®¡ç†åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...</p>
                    </div>
                </div>

                <!-- ç»Ÿè®¡æ ‡ç­¾é¡µ -->
                <div id="statistics" class="tab-content">
                    <div class="page-header">
                        <h2>ğŸ“Š å·¥ä½œç»Ÿè®¡</h2>
                    </div>
                    <div class="placeholder-content">
                        <p>å·¥ä½œç»Ÿè®¡åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...</p>
                    </div>
                </div>

                <!-- è®¾ç½®æ ‡ç­¾é¡µ -->
                <div id="settings" class="tab-content">
                    <div class="page-header">
                        <h2>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h2>
                    </div>
                    <div class="placeholder-content">
                        <p>ç³»ç»Ÿè®¾ç½®åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç­‰å¾…Tauri APIå‡†å¤‡å°±ç»ª
        let invoke;

        async function initializeTauri() {
            try {
                // æ£€æŸ¥Tauriæ˜¯å¦å¯ç”¨
                if (typeof window.__TAURI__ === 'undefined') {
                    console.error('Tauri API æœªåŠ è½½');
                    throw new Error('Tauri API æœªåŠ è½½');
                }

                console.log('Tauri å¯¹è±¡ç»“æ„:', Object.keys(window.__TAURI__));

                // å°è¯•ä¸åŒçš„APIè®¿é—®æ–¹å¼
                if (window.__TAURI__.invoke) {
                    // Tauri 1.x é£æ ¼
                    invoke = window.__TAURI__.invoke;
                    console.log('ä½¿ç”¨ Tauri 1.x API é£æ ¼');
                } else if (window.__TAURI__.tauri && window.__TAURI__.tauri.invoke) {
                    // Tauri 2.x é£æ ¼
                    invoke = window.__TAURI__.tauri.invoke;
                    console.log('ä½¿ç”¨ Tauri 2.x API é£æ ¼');
                } else if (window.__TAURI__.core && window.__TAURI__.core.invoke) {
                    // å¦ä¸€ç§å¯èƒ½çš„ç»“æ„
                    invoke = window.__TAURI__.core.invoke;
                    console.log('ä½¿ç”¨ Tauri core API é£æ ¼');
                } else {
                    console.error('æœªæ‰¾åˆ° invoke å‡½æ•°ï¼Œå¯ç”¨çš„å±æ€§:', Object.keys(window.__TAURI__));
                    throw new Error('æœªæ‰¾åˆ° invoke å‡½æ•°');
                }

                console.log('Tauri API åˆå§‹åŒ–æˆåŠŸ');
                return true;
            } catch (error) {
                console.error('Tauri API åˆå§‹åŒ–å¤±è´¥:', error);
                return false;
            }
        }

        // DOM å…ƒç´ 
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const loginBtn = document.getElementById('login-btn');
        const loginMessage = document.getElementById('login-message');
        const userDisplayName = document.getElementById('user-display-name');
        const logoutBtn = document.getElementById('logout-btn');

        // è®¾å¤‡ç®¡ç†ç›¸å…³çš„DOMå…ƒç´ 
        let devicesGridEl, deviceCountEl, availableCountEl, connectedCountEl, noDevicesEl, adbStatusEl;
        let currentDevices = [];
        let connectedDevicesMap = new Map(); // å­˜å‚¨å·²è¿æ¥è®¾å¤‡çš„çŠ¶æ€

        // åˆå§‹åŒ–è®¾å¤‡ç®¡ç†DOMå…ƒç´ 
        function initializeDeviceManagementElements() {
            try {
                devicesGridEl = document.getElementById('devices-grid');
                deviceCountEl = document.getElementById('device-count');
                availableCountEl = document.getElementById('available-count');
                connectedCountEl = document.getElementById('connected-count');
                noDevicesEl = document.getElementById('no-devices');
                adbStatusEl = document.getElementById('adb-status');

                console.log('è®¾å¤‡ç®¡ç†DOMå…ƒç´ åˆå§‹åŒ–:', {
                    devicesGridEl: !!devicesGridEl,
                    deviceCountEl: !!deviceCountEl,
                    availableCountEl: !!availableCountEl,
                    connectedCountEl: !!connectedCountEl,
                    noDevicesEl: !!noDevicesEl,
                    adbStatusEl: !!adbStatusEl
                });

                // ç»‘å®šäº‹ä»¶
                const refreshBtn = document.getElementById('refresh-devices-btn');
                const checkAdbBtn = document.getElementById('check-adb-btn');
                const scanBtn = document.getElementById('scan-devices-btn');

                if (refreshBtn) refreshBtn.addEventListener('click', refreshDevices);
                if (checkAdbBtn) checkAdbBtn.addEventListener('click', checkAdbStatus);
                if (scanBtn) scanBtn.addEventListener('click', refreshDevices);

                // ç»‘å®šæ ‡ç­¾é¡µåˆ‡æ¢
                const navTabs = document.querySelectorAll('.nav-tab');
                console.log('æ‰¾åˆ°å¯¼èˆªæ ‡ç­¾é¡µæ•°é‡:', navTabs.length);
                navTabs.forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const tabId = e.target.dataset.tab;
                        console.log('åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ:', tabId);
                        switchTab(tabId);
                    });
                });
            } catch (error) {
                console.error('åˆå§‹åŒ–è®¾å¤‡ç®¡ç†å…ƒç´ å¤±è´¥:', error);
            }
        }

        // åº”ç”¨åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM åŠ è½½å®Œæˆï¼Œå¼€å§‹åº”ç”¨åˆå§‹åŒ–...');

            // é¦–å…ˆåˆå§‹åŒ–Tauri API
            const tauriReady = await initializeTauri();
            if (!tauriReady) {
                showMessage('åº”ç”¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡æ–°å¯åŠ¨åº”ç”¨', 'error');
                return;
            }

            try {
                // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
                const isLoggedIn = await invoke('is_logged_in');
                console.log('ç™»å½•çŠ¶æ€æ£€æŸ¥:', isLoggedIn);

                if (isLoggedIn) {
                    const currentUser = await invoke('get_current_user');
                    console.log('å½“å‰ç”¨æˆ·:', currentUser);
                    if (currentUser) {
                        console.log('æ˜¾ç¤ºä¸»åº”ç”¨ç•Œé¢');
                        showMainApp(currentUser);
                        return;
                    } else {
                        console.log('ç”¨æˆ·ä¿¡æ¯ä¸ºç©ºï¼Œæ˜¾ç¤ºç™»å½•ç•Œé¢');
                    }
                } else {
                    console.log('æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•ç•Œé¢');
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
            }

            // æ˜¾ç¤ºç™»å½•ç•Œé¢
            showLoginScreen();
        });

        // ç™»å½•è¡¨å•æäº¤
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!username || !password) {
                showMessage('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'error');
                return;
            }

            setLoading(true);
            hideMessage();

            try {
                console.log('å°è¯•ç™»å½•:', username);
                console.log('Tauri API å¯ç”¨:', typeof window.__TAURI__ !== 'undefined');
                console.log('invoke å‡½æ•°å¯ç”¨:', typeof invoke === 'function');

                if (!invoke) {
                    throw new Error('Tauri API æœªåˆå§‹åŒ–');
                }

                const session = await invoke('login', { username, password });
                console.log('ç™»å½•æˆåŠŸ:', session);

                showMessage('ç™»å½•æˆåŠŸï¼', 'success');
                setTimeout(() => {
                    showMainApp(session.user);
                }, 1000);

            } catch (error) {
                console.error('ç™»å½•å¤±è´¥è¯¦ç»†ä¿¡æ¯:', error);
                console.error('é”™è¯¯ç±»å‹:', typeof error);
                console.error('é”™è¯¯JSON:', JSON.stringify(error));

                let errorMessage;
                if (typeof error === 'object' && error.message) {
                    errorMessage = error.message;
                } else if (typeof error === 'string') {
                    errorMessage = error;
                } else {
                    errorMessage = 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ';
                }

                showMessage(errorMessage, 'error');
            } finally {
                setLoading(false);
            }
        });

        // é€€å‡ºç™»å½•
        logoutBtn.addEventListener('click', async () => {
            try {
                await invoke('logout');
                console.log('å·²é€€å‡ºç™»å½•');
                showLoginScreen();
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
            }
        });

        // æ˜¾ç¤ºç™»å½•ç•Œé¢
        function showLoginScreen() {
            console.log('showLoginScreen è¢«è°ƒç”¨');
            loginScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');

            // æ¸…ç©ºç™»å½•è¡¨å•
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            hideMessage();
        }

        // æ˜¾ç¤ºä¸»åº”ç”¨ç•Œé¢
        function showMainApp(user) {
            console.log('showMainApp è¢«è°ƒç”¨ï¼Œç”¨æˆ·æ•°æ®:', user);

            if (!user) {
                console.error('ç”¨æˆ·æ•°æ®ä¸ºç©º');
                showMessage('ç”¨æˆ·æ•°æ®è·å–å¤±è´¥', 'error');
                showLoginScreen();
                return;
            }

            loginScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');

            // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
            const displayName = user.full_name || user.username;
            console.log('è®¾ç½®æ˜¾ç¤ºåç§°:', displayName);
            if (userDisplayName) {
                userDisplayName.textContent = `${displayName} (${user.role})`;
            }

            console.log('ä¸»åº”ç”¨ç•Œé¢åº”è¯¥ç°åœ¨å¯è§äº†');
            console.log('loginScreen hidden:', loginScreen.classList.contains('hidden'));
            console.log('mainApp hidden:', mainApp.classList.contains('hidden'));

            // åˆå§‹åŒ–è®¾å¤‡ç®¡ç†
            initializeDeviceManagementElements();

            // å»¶è¿Ÿæ‰§è¡Œè®¾å¤‡æ£€æŸ¥ï¼Œç¡®ä¿DOMå·²æ¸²æŸ“
            setTimeout(() => {
                console.log('å¼€å§‹æ‰§è¡Œè®¾å¤‡çŠ¶æ€æ£€æŸ¥å’Œåˆ·æ–°...');
                checkAdbStatus();
                refreshDevices();
            }, 500);
        }

        // ========== è®¾å¤‡ç®¡ç†åŠŸèƒ½ ==========

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabId) {
            try {
                console.log('åˆ‡æ¢æ ‡ç­¾é¡µåˆ°:', tabId);

                // åˆ‡æ¢æ ‡ç­¾é¡µæŒ‰é’®çŠ¶æ€
                const navTabs = document.querySelectorAll('.nav-tab');
                navTabs.forEach(tab => {
                    tab.classList.remove('active');
                });

                const activeTab = document.querySelector(`[data-tab="${tabId}"]`);
                if (activeTab) {
                    activeTab.classList.add('active');
                    console.log('æ¿€æ´»æ ‡ç­¾é¡µæŒ‰é’®:', tabId);
                } else {
                    console.warn('æœªæ‰¾åˆ°æ ‡ç­¾é¡µæŒ‰é’®:', tabId);
                }

                // åˆ‡æ¢æ ‡ç­¾é¡µå†…å®¹
                const tabContents = document.querySelectorAll('.tab-content');
                tabContents.forEach(content => {
                    content.classList.remove('active');
                });

                const activeContent = document.getElementById(tabId);
                if (activeContent) {
                    activeContent.classList.add('active');
                    console.log('æ˜¾ç¤ºæ ‡ç­¾é¡µå†…å®¹:', tabId);
                } else {
                    console.warn('æœªæ‰¾åˆ°æ ‡ç­¾é¡µå†…å®¹:', tabId);
                }
            } catch (error) {
                console.error('åˆ‡æ¢æ ‡ç­¾é¡µå¤±è´¥:', error);
            }
        }

        // æ£€æŸ¥ADBçŠ¶æ€
        async function checkAdbStatus() {
            try {
                updateAdbStatus('æ£€æŸ¥ADBè¿æ¥çŠ¶æ€...', 'unknown');

                const isAvailable = await invoke('check_adb_available');

                if (isAvailable) {
                    updateAdbStatus('ADBè¿æ¥æ­£å¸¸', 'online');
                    hideAdbConfig();
                } else {
                    updateAdbStatus('ADBæœªå®‰è£…æˆ–ä¸å¯ç”¨ - è¯·é…ç½®ADBè·¯å¾„', 'offline');
                    showAdbConfig();
                }

                return isAvailable;
            } catch (error) {
                console.error('æ£€æŸ¥ADBçŠ¶æ€å¤±è´¥:', error);
                updateAdbStatus('ADBçŠ¶æ€æ£€æŸ¥å¤±è´¥ - è¯·é…ç½®ADBè·¯å¾„', 'offline');
                showAdbConfig();
                return false;
            }
        }

        // æ˜¾ç¤ºADBé…ç½®åŒºåŸŸ
        function showAdbConfig() {
            const configEl = document.getElementById('adb-config');
            if (configEl) {
                configEl.classList.remove('hidden');
            }
        }

        // éšè—ADBé…ç½®åŒºåŸŸ
        function hideAdbConfig() {
            const configEl = document.getElementById('adb-config');
            if (configEl) {
                configEl.classList.add('hidden');
            }
        }

        // è®¾ç½®ADBè·¯å¾„
        async function setAdbPath() {
            const pathInput = document.getElementById('adb-path-input');
            const adbPath = pathInput.value.trim();

            if (!adbPath) {
                showNotification('è¯·è¾“å…¥ADBè·¯å¾„', 'error');
                return;
            }

            try {
                showNotification('æ­£åœ¨éªŒè¯ADBè·¯å¾„...', 'info');

                const isValid = await invoke('set_adb_path', { adbPath });

                if (isValid) {
                    showNotification('ADBè·¯å¾„è®¾ç½®æˆåŠŸï¼', 'success');
                    // é‡æ–°æ£€æŸ¥ADBçŠ¶æ€
                    setTimeout(() => {
                        checkAdbStatus();
                    }, 1000);
                } else {
                    showNotification('ADBè·¯å¾„æ— æ•ˆ', 'error');
                }
            } catch (error) {
                console.error('è®¾ç½®ADBè·¯å¾„å¤±è´¥:', error);
                showNotification('ADBè·¯å¾„è®¾ç½®å¤±è´¥: ' + error, 'error');
            }
        }

        // è‡ªåŠ¨æœç´¢ADBå®‰è£…
        async function findAdbInstallations() {
            try {
                showNotification('æ­£åœ¨æœç´¢ADBç¨‹åº...', 'info');

                const foundPaths = await invoke('find_adb_installations');

                if (foundPaths.length > 0) {
                    // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„è·¯å¾„
                    const pathInput = document.getElementById('adb-path-input');
                    pathInput.value = foundPaths[0];

                    showNotification(`æ‰¾åˆ° ${foundPaths.length} ä¸ªADBç¨‹åºï¼Œå·²è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ª`, 'success');

                    // å¦‚æœæ‰¾åˆ°äº†è·¯å¾„ï¼Œæç¤ºç”¨æˆ·å¯ä»¥ç‚¹å‡»è®¾ç½®
                    setTimeout(() => {
                        showNotification('è¯·ç‚¹å‡»"è®¾ç½®"æŒ‰é’®åº”ç”¨ADBè·¯å¾„', 'info');
                    }, 2000);
                } else {
                    showNotification('æœªæ‰¾åˆ°ADBç¨‹åºï¼Œè¯·æ‰‹åŠ¨è¾“å…¥è·¯å¾„', 'info');
                }
            } catch (error) {
                console.error('æœç´¢ADBå®‰è£…å¤±è´¥:', error);
                showNotification('æœç´¢ADBå®‰è£…å¤±è´¥: ' + error, 'error');
            }
        }

        // æ›´æ–°ADBçŠ¶æ€æ˜¾ç¤º
        function updateAdbStatus(message, status) {
            if (!adbStatusEl) return;

            const indicator = adbStatusEl.querySelector('.status-indicator');
            const dot = indicator.querySelector('.status-dot');
            const text = indicator.querySelector('.status-text');

            dot.className = `status-dot status-${status}`;
            text.textContent = message;
        }

        // åˆ·æ–°è®¾å¤‡åˆ—è¡¨
        async function refreshDevices() {
            try {
                console.log('å¼€å§‹åˆ·æ–°è®¾å¤‡åˆ—è¡¨');

                // æ£€æŸ¥ADBæ˜¯å¦å¯ç”¨
                const adbAvailable = await checkAdbStatus();
                if (!adbAvailable) {
                    showNotification('ADBä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ADBå®‰è£…', 'error');
                    updateDevicesList([]);
                    return;
                }

                showNotification('æ­£åœ¨æ‰«æè®¾å¤‡...', 'info');

                const devices = await invoke('get_adb_devices');
                console.log('è·å–åˆ°çš„è®¾å¤‡åˆ—è¡¨:', devices);

                // ç¡®ä¿devicesæ˜¯ä¸€ä¸ªæ•°ç»„
                const deviceList = Array.isArray(devices) ? devices : [];
                currentDevices = deviceList;
                updateDevicesList(currentDevices);

                if (deviceList.length > 0) {
                    showNotification(`å‘ç° ${deviceList.length} ä¸ªè®¾å¤‡`, 'success');
                } else {
                    showNotification('æœªå‘ç°ä»»ä½•è®¾å¤‡', 'info');
                }

            } catch (error) {
                console.error('åˆ·æ–°è®¾å¤‡åˆ—è¡¨å¤±è´¥:', error);
                showNotification('è®¾å¤‡æ‰«æå¤±è´¥: ' + (error.message || error), 'error');
                updateDevicesList([]);
            }
        }

        // æ›´æ–°è®¾å¤‡åˆ—è¡¨æ˜¾ç¤º
        function updateDevicesList(devices) {
            if (!devicesGridEl || !deviceCountEl || !availableCountEl || !connectedCountEl || !noDevicesEl) {
                console.warn('è®¾å¤‡ç®¡ç†å…ƒç´ æœªåˆå§‹åŒ–');
                return;
            }

            // ç¡®ä¿devicesæ˜¯ä¸€ä¸ªæ•°ç»„
            const validDevices = Array.isArray(devices) ? devices : [];
            const deviceCount = validDevices.length;
            const availableDevices = validDevices.filter(d => d && (d.status === 'device' || d.status === 'available'));
            const connectedDevices = validDevices.filter(d => d && connectedDevicesMap.has(d.id));

            // æ›´æ–°ç»Ÿè®¡æ•°å­—
            deviceCountEl.textContent = deviceCount;
            availableCountEl.textContent = availableDevices.length;
            connectedCountEl.textContent = connectedDevices.length;

            // æ¸…ç©ºè®¾å¤‡ç½‘æ ¼
            devicesGridEl.innerHTML = '';

            if (deviceCount === 0) {
                // æ˜¾ç¤ºç©ºçŠ¶æ€
                noDevicesEl.classList.remove('hidden');
                noDevicesEl.classList.add('show-block');
                devicesGridEl.classList.add('hidden');
                devicesGridEl.classList.remove('show-grid');
            } else {
                // éšè—ç©ºçŠ¶æ€ï¼Œæ˜¾ç¤ºè®¾å¤‡ç½‘æ ¼
                noDevicesEl.classList.add('hidden');
                noDevicesEl.classList.remove('show-block');
                devicesGridEl.classList.remove('hidden');
                devicesGridEl.classList.add('show-grid');

                // ç”Ÿæˆè®¾å¤‡å¡ç‰‡
                validDevices.forEach((device, index) => {
                    if (device && index < 10) { // æœ€å¤šæ˜¾ç¤º10ä¸ªè®¾å¤‡
                        try {
                            const deviceCard = createDeviceCard(device, index + 1);
                            devicesGridEl.appendChild(deviceCard);
                        } catch (error) {
                            console.error('åˆ›å»ºè®¾å¤‡å¡ç‰‡å¤±è´¥:', error, device);
                        }
                    }
                });
            }
        }

        // åˆ›å»ºè®¾å¤‡å¡ç‰‡
        function createDeviceCard(device, slotNumber) {
            if (!device || !device.id) {
                console.error('æ— æ•ˆçš„è®¾å¤‡æ•°æ®:', device);
                return document.createElement('div');
            }

            const isConnected = connectedDevicesMap.has(device.id);
            const isAvailable = device.status === 'device';

            const card = document.createElement('div');
            card.className = `device-card ${isConnected ? 'connected' : ''} ${!isAvailable ? 'offline' : ''}`;
            card.dataset.deviceId = device.id;

            // è·å–è®¾å¤‡çŠ¶æ€å’Œæ ·å¼
            let statusText, statusClass;
            if (isConnected) {
                statusText = 'å·²è¿æ¥';
                statusClass = 'connected';
            } else if (isAvailable) {
                statusText = 'å¯è¿æ¥';
                statusClass = 'available';
            } else if (device.status === 'unauthorized') {
                statusText = 'æœªæˆæƒ';
                statusClass = 'unauthorized';
            } else {
                statusText = 'ç¦»çº¿';
                statusClass = 'offline';
            }

            card.innerHTML = `
                <div class="device-header">
                    <div class="device-name">è®¾å¤‡ ${slotNumber}</div>
                    <div class="device-status ${statusClass}">${statusText}</div>
                </div>
                <div class="device-info">
                    <div class="device-info-row">
                        <span class="device-info-label">è®¾å¤‡ID:</span>
                        <span class="device-info-value">${device.id || 'æœªçŸ¥'}</span>
                    </div>
                    <div class="device-info-row">
                        <span class="device-info-label">å‹å·:</span>
                        <span class="device-info-value">${device.model || 'æœªçŸ¥'}</span>
                    </div>
                    <div class="device-info-row">
                        <span class="device-info-label">Androidç‰ˆæœ¬:</span>
                        <span class="device-info-value">${device.android_version || 'æœªçŸ¥'}</span>
                    </div>
                    ${device.battery_level ? `
                    <div class="device-info-row">
                        <span class="device-info-label">ç”µé‡:</span>
                        <span class="device-info-value">${device.battery_level}%</span>
                    </div>
                    ` : ''}
                </div>
                <div class="device-actions">
                    ${getDeviceActionButton(device, isConnected, isAvailable)}
                    <button class="btn btn-info" onclick="showDeviceInfo('${device.id}')">è¯¦æƒ…</button>
                </div>
            `;

            return card;
        }

        // è·å–è®¾å¤‡æ“ä½œæŒ‰é’®
        function getDeviceActionButton(device, isConnected, isAvailable) {
            if (isConnected) {
                return `<button class="btn btn-danger" onclick="disconnectDevice('${device.id}')">æ–­å¼€è¿æ¥</button>`;
            } else if (isAvailable) {
                return `<button class="btn btn-success" onclick="connectDevice('${device.id}')">è¿æ¥</button>`;
            } else {
                return `<button class="btn btn-secondary" disabled>ä¸å¯ç”¨</button>`;
            }
        }

        // è¿æ¥è®¾å¤‡
        async function connectDevice(deviceId) {
            try {
                showNotification('æ­£åœ¨è¿æ¥è®¾å¤‡...', 'info');

                const device = await invoke('connect_adb_device', { deviceId });
                console.log('è®¾å¤‡è¿æ¥æˆåŠŸ:', device);

                // æ›´æ–°è¿æ¥çŠ¶æ€
                connectedDevicesMap.set(deviceId, device);

                // åˆ·æ–°è®¾å¤‡åˆ—è¡¨æ˜¾ç¤º
                updateDevicesList(currentDevices);

                showNotification('è®¾å¤‡è¿æ¥æˆåŠŸ', 'success');

            } catch (error) {
                console.error('è¿æ¥è®¾å¤‡å¤±è´¥:', error);
                showNotification('è®¾å¤‡è¿æ¥å¤±è´¥: ' + error, 'error');
            }
        }

        // æ–­å¼€è®¾å¤‡è¿æ¥
        async function disconnectDevice(deviceId) {
            try {
                showNotification('æ­£åœ¨æ–­å¼€è®¾å¤‡...', 'info');

                await invoke('disconnect_adb_device', { deviceId });
                console.log('è®¾å¤‡æ–­å¼€æˆåŠŸ:', deviceId);

                // æ›´æ–°è¿æ¥çŠ¶æ€
                connectedDevicesMap.delete(deviceId);

                // åˆ·æ–°è®¾å¤‡åˆ—è¡¨æ˜¾ç¤º
                updateDevicesList(currentDevices);

                showNotification('è®¾å¤‡æ–­å¼€æˆåŠŸ', 'success');

            } catch (error) {
                console.error('æ–­å¼€è®¾å¤‡å¤±è´¥:', error);
                showNotification('è®¾å¤‡æ–­å¼€å¤±è´¥: ' + error, 'error');
            }
        }

        // æ˜¾ç¤ºè®¾å¤‡è¯¦ç»†ä¿¡æ¯
        async function showDeviceInfo(deviceId) {
            try {
                const device = await invoke('get_device_info', { deviceId });

                if (device) {
                    alert(`è®¾å¤‡è¯¦ç»†ä¿¡æ¯:\n\nè®¾å¤‡ID: ${device.id}\nåç§°: ${device.name}\nå‹å·: ${device.model || 'æœªçŸ¥'}\nåˆ¶é€ å•†: ${device.manufacturer || 'æœªçŸ¥'}\nAndroidç‰ˆæœ¬: ${device.android_version || 'æœªçŸ¥'}\nå±å¹•åˆ†è¾¨ç‡: ${device.screen_resolution || 'æœªçŸ¥'}\nç”µé‡: ${device.battery_level ? device.battery_level + '%' : 'æœªçŸ¥'}\nçŠ¶æ€: ${device.status}\næœ€åæ£€æµ‹æ—¶é—´: ${new Date(device.last_seen).toLocaleString()}`);
                } else {
                    showNotification('è·å–è®¾å¤‡ä¿¡æ¯å¤±è´¥', 'error');
                }

            } catch (error) {
                console.error('è·å–è®¾å¤‡ä¿¡æ¯å¤±è´¥:', error);
                showNotification('è·å–è®¾å¤‡ä¿¡æ¯å¤±è´¥: ' + error, 'error');
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info', duration = 3000) {
            // ç§»é™¤å·²å­˜åœ¨çš„é€šçŸ¥
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // åˆ›å»ºæ–°é€šçŸ¥
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            document.body.appendChild(notification);

            // è‡ªåŠ¨ç§»é™¤é€šçŸ¥
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, duration);
        }

        // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä¾›HTMLä¸­çš„onclickä½¿ç”¨
        window.connectDevice = connectDevice;
        window.disconnectDevice = disconnectDevice;
        window.showDeviceInfo = showDeviceInfo;
        window.setAdbPath = setAdbPath;
        window.findAdbInstallations = findAdbInstallations;

        // è®¾ç½®åŠ è½½çŠ¶æ€
        function setLoading(loading) {
            const loginBtn = document.getElementById('login-btn');

            if (loading) {
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<span class="loading"></span>ç™»å½•ä¸­...';
            } else {
                loginBtn.disabled = false;
                loginBtn.innerHTML = 'ç™»å½•';
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'error') {
            const messageEl = document.getElementById('login-message');
            messageEl.textContent = message;
            messageEl.className = type === 'error' ? 'error-message' : 'success-message';
            messageEl.classList.remove('hidden');
        }

        // éšè—æ¶ˆæ¯
        function hideMessage() {
            const messageEl = document.getElementById('login-message');
            messageEl.classList.add('hidden');
        }

        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('unhandledrejection', (event) => {
            console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
            showMessage('ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });

        window.addEventListener('error', (event) => {
            console.error('å…¨å±€é”™è¯¯:', event.error);
            showMessage('ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    </script>
</body>
</html>
