---
description: "åˆ›å»ºè®¡è´¹ç³»ç»Ÿå’Œä½™é¢ç®¡ç†æ¨¡å—"
mode: "edit"
tools: ["file-system", "terminal"]
---

# è®¡è´¹ç³»ç»Ÿå¼€å‘

å¼€å‘ä¸€ä¸ªå®Œæ•´çš„å®æ—¶è®¡è´¹å’Œä½™é¢ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒåŸºäºæˆåŠŸå…³æ³¨çš„æ‰£è´¹æœºåˆ¶ã€‚

## æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### 1. ä½™é¢æ˜¾ç¤ºå’Œç®¡ç†
- å®æ—¶ä½™é¢æ˜¾ç¤ºï¼ˆç²¾ç¡®åˆ°åˆ†ï¼‰
- ä½™é¢å˜æ›´å†å²è®°å½•
- å……å€¼å’Œæ¶ˆè´¹æ˜ç»†
- ä½ä½™é¢é¢„è­¦æé†’

### 2. è®¡è´¹è§„åˆ™é…ç½®
- æœåŠ¡å™¨ç«¯è§„åˆ™åŒæ­¥
- ä¸åŒå¹³å°ä¸åŒè®¡è´¹æ ‡å‡†ï¼š
  - å°çº¢ä¹¦å…³æ³¨ï¼šÂ¥1.00/æ¬¡
  - æŠ–éŸ³å…³æ³¨ï¼šÂ¥1.20/æ¬¡
  - æ‰¹é‡æ“ä½œæŠ˜æ‰£è®¡ç®—
- å®æ—¶è´¹ç‡æ›´æ–°

### 3. ä»»åŠ¡å‰ä½™é¢æ£€æŸ¥
- æäº¤ä»»åŠ¡å‰é¢„ç®—è®¡ç®—
- ä½™é¢å……è¶³æ€§éªŒè¯
- ä¸è¶³ä½™é¢çš„å‹å¥½æç¤º
- ä»»åŠ¡æš‚åœå’Œæ¢å¤æœºåˆ¶

### 4. æˆåŠŸæ‰£è´¹é€»è¾‘
- ä»…æˆåŠŸå…³æ³¨åæ‰£è´¹
- å®æ—¶ä¸æœåŠ¡å™¨åŒæ­¥
- å¤±è´¥æ“ä½œä¸æ‰£è´¹
- é€€æ¬¾å’Œè°ƒæ•´æœºåˆ¶

## æŠ€æœ¯å®ç°æ¶æ„

```python
from qfluentwidgets import (
    VerticalScrollInterface, InfoBar,
    PrimaryPushButton, LineEdit,
    TableWidget, ProgressBar, FluentIcon
)

class BillingManager:
    def __init__(self, api_client):
        self.api_client = api_client
        self.current_balance = 0.0
        self.billing_rules = {}
        self.transaction_history = []

    async def get_current_balance(self):
        """è·å–å½“å‰ä½™é¢"""
        response = await self.api_client.get("/api/balance")
        self.current_balance = response["balance"]
        return self.current_balance

    async def calculate_task_cost(self, task_type, platform, quantity):
        """è®¡ç®—ä»»åŠ¡é¢„ä¼°è´¹ç”¨"""
        rate = self.billing_rules.get(f"{platform}_{task_type}", 1.0)
        return rate * quantity

    async def check_balance_sufficient(self, required_amount):
        """æ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶³"""
        current = await self.get_current_balance()
        return current >= required_amount

    async def record_successful_follow(self, user_id, platform, cost):
        """è®°å½•æˆåŠŸå…³æ³¨å¹¶æ‰£è´¹"""
        try:
            response = await self.api_client.post("/api/billing/charge", {
                "user_id": user_id,
                "platform": platform,
                "operation": "follow",
                "cost": cost,
                "timestamp": datetime.now().isoformat()
            })
            if response["success"]:
                self.current_balance -= cost
                self.transaction_history.append({
                    "type": "charge",
                    "amount": -cost,
                    "description": f"{platform}å…³æ³¨ç”¨æˆ·{user_id}",
                    "timestamp": datetime.now()
                })
                return True
            return False
        except Exception as e:
            # æ‰£è´¹å¤±è´¥ï¼Œè®°å½•ä½†ä¸å½±å“ä¸»æµç¨‹
            logger.error(f"è®¡è´¹å¤±è´¥: {e}")
            return False

class BillingInterface(VerticalScrollInterface):
    def __init__(self, billing_manager):
        super().__init__(
            object_name="billing_management",
            nav_text_cn="ä½™é¢ç®¡ç†",
            nav_icon=FluentIcon.MONEY
        )
        self.billing_manager = billing_manager
        self.setup_ui()

    def setup_ui(self):
        # ä½™é¢æ˜¾ç¤ºåŒºåŸŸ
        # æ¶ˆè´¹å†å²åŒºåŸŸ
        # è®¡è´¹è§„åˆ™æ˜¾ç¤ºåŒºåŸŸ
        # é¢„ç®—è®¡ç®—å™¨
```

## ç•Œé¢è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’° ä½™é¢ç®¡ç†ä¸­å¿ƒ                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å½“å‰ä½™é¢: Â¥1,250.68                                 â”‚
â”‚ ğŸ“Š ä»Šæ—¥æ¶ˆè´¹: Â¥125.50 | æœ¬æœˆæ¶ˆè´¹: Â¥2,850.20         â”‚
â”‚ [å……å€¼] [æ¶ˆè´¹æ˜ç»†] [å¯¼å‡ºè´¦å•]                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“‹ è®¡è´¹æ ‡å‡† (æœ€åæ›´æ–°: 2025-01-15 10:30)            â”‚
â”‚ â€¢ å°çº¢ä¹¦å…³æ³¨: Â¥1.00/æ¬¡                              â”‚
â”‚ â€¢ æŠ–éŸ³å…³æ³¨: Â¥1.20/æ¬¡                                â”‚
â”‚ â€¢ æ‰¹é‡æ“ä½œ(>100): 9.5æŠ˜ä¼˜æƒ                          â”‚
â”‚ â€¢ é«˜çº§ä¼šå‘˜: 9æŠ˜ä¼˜æƒ                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ§® è´¹ç”¨è®¡ç®—å™¨                                       â”‚
â”‚ å¹³å°: [å°çº¢ä¹¦ â–¼] æ“ä½œç±»å‹: [å…³æ³¨ â–¼]                â”‚
â”‚ æ•°é‡: [500____] é¢„è®¡è´¹ç”¨: Â¥475.00 (å«5%æŠ˜æ‰£)       â”‚
â”‚ ä½™é¢æ£€æŸ¥: âœ… å……è¶³ (å‰©ä½™: Â¥775.68)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“ˆ æ¶ˆè´¹å†å² (æœ€è¿‘10æ¡)                              â”‚
â”‚ æ—¶é—´       â”‚ç±»å‹    â”‚å¹³å°  â”‚æ•°é‡â”‚é‡‘é¢   â”‚ä½™é¢      â”‚
â”‚ 10:25:30  â”‚å…³æ³¨    â”‚å°çº¢ä¹¦â”‚ 50 â”‚-Â¥50.00â”‚Â¥1,250.68 â”‚
â”‚ 10:20:15  â”‚å…³æ³¨    â”‚æŠ–éŸ³  â”‚ 25 â”‚-Â¥30.00â”‚Â¥1,300.68 â”‚
â”‚ 09:45:20  â”‚å……å€¼    â”‚--   â”‚ -- â”‚+Â¥500.00â”‚Â¥1,330.68â”‚
â”‚ [æŸ¥çœ‹å…¨éƒ¨] [å¯¼å‡ºExcel]                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âš ï¸  ä½™é¢é¢„è­¦è®¾ç½®                                     â”‚
â”‚ ä½äº [Â¥100___] æ—¶æé†’ â˜‘                            â”‚
â”‚ ä»»åŠ¡æš‚åœé˜ˆå€¼: [Â¥50___] â˜‘                           â”‚
â”‚ é‚®ä»¶é€šçŸ¥: user@example.com â˜‘                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å…³é”®ä¸šåŠ¡é€»è¾‘

### 1. ä»»åŠ¡æäº¤å‰æ£€æŸ¥æµç¨‹
```python
async def submit_task(self, task_data):
    # 1. è®¡ç®—ä»»åŠ¡é¢„ä¼°è´¹ç”¨
    estimated_cost = await self.calculate_task_cost(task_data)

    # 2. æ£€æŸ¥ä½™é¢å……è¶³æ€§
    if not await self.check_balance_sufficient(estimated_cost):
        self.show_insufficient_balance_dialog(estimated_cost)
        return False

    # 3. æ˜¾ç¤ºè´¹ç”¨ç¡®è®¤å¯¹è¯æ¡†
    if await self.confirm_task_cost(estimated_cost):
        return await self.execute_task(task_data)

    return False
```

### 2. å®æ—¶æ‰£è´¹æµç¨‹
```python
async def process_successful_follow(self, user_id, platform):
    # 1. è·å–å½“å‰è´¹ç‡
    rate = await self.get_current_rate(platform, "follow")

    # 2. è®°å½•æˆåŠŸå…³æ³¨å¹¶æ‰£è´¹
    success = await self.record_successful_follow(user_id, platform, rate)

    # 3. æ›´æ–°UIæ˜¾ç¤º
    if success:
        self.update_balance_display()
        self.add_transaction_record(user_id, platform, rate)

    return success
```

### 3. é˜²é‡å¤æ‰£è´¹æœºåˆ¶
- åŸºäºå”¯ä¸€äº‹åŠ¡IDé˜²é‡å¤
- æœåŠ¡å™¨ç«¯å¹‚ç­‰æ€§ä¿è¯
- å®¢æˆ·ç«¯çŠ¶æ€è¿½è¸ª
- å¼‚å¸¸æƒ…å†µå›æ»šæœºåˆ¶

### 4. æ•°æ®åŒæ­¥ç­–ç•¥
- å®æ—¶ä½™é¢åŒæ­¥ï¼ˆæ¯æ¬¡æ“ä½œåï¼‰
- å®šæ—¶å…¨é‡åŒæ­¥ï¼ˆæ¯5åˆ†é’Ÿï¼‰
- ç¦»çº¿ç¼“å­˜å’ŒåŒæ­¥é˜Ÿåˆ—
- å†²çªæ£€æµ‹å’Œè§£å†³

## é”™è¯¯å¤„ç†

1. **ç½‘ç»œå¼‚å¸¸**: æœ¬åœ°ç¼“å­˜æ“ä½œï¼Œç½‘ç»œæ¢å¤ååŒæ­¥
2. **æœåŠ¡å™¨é”™è¯¯**: é‡è¯•æœºåˆ¶ï¼Œæœ€å¤š3æ¬¡
3. **ä½™é¢ä¸è¶³**: å‹å¥½æç¤ºï¼Œå¼•å¯¼å……å€¼
4. **è®¡è´¹å¤±è´¥**: è®°å½•æ—¥å¿—ï¼Œä¸å½±å“ä¸»è¦åŠŸèƒ½
5. **æ•°æ®ä¸ä¸€è‡´**: å¼ºåˆ¶åŒæ­¥ï¼Œç”¨æˆ·ç¡®è®¤

å‚è€ƒserver-backend APIè®¾è®¡å’Œæ•°æ®åº“schemaè¿›è¡Œå¼€å‘ã€‚
