# Flow Farm 项目架构可视化

## 系统架构总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Flow Farm 生态系统                                  │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                        前端层 (Presentation Layer)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │             服务器前端 (React + TypeScript)                       │       │
│  │  端口: 3000 (开发) / 8000/static (生产)                          │       │
│  ├─────────────────────────────────────────────────────────────────┤       │
│  │  组件:                                                           │       │
│  │  • SystemAdminDashboard  (系统管理员仪表板)                      │       │
│  │  • UserAdminDashboard    (用户管理员仪表板)                      │       │
│  │  • Login                 (登录页面)                             │       │
│  │                                                                  │       │
│  │  状态管理: Redux Toolkit                                         │       │
│  │  UI库: Ant Design 5                                             │       │
│  │  路由: React Router 7                                           │       │
│  │  图表: ECharts                                                  │       │
│  └─────────────────────────────────────────────────────────────────┘       │
│                              ↓ ↑                                             │
│                        HTTP REST API                                         │
│                   (JSON, JWT Bearer Token)                                   │
│                              ↓ ↑                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                        后端层 (Backend Layer)                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │             服务器后端 (Rust + Axum)                             │       │
│  │  端口: 8000                                                      │       │
│  ├─────────────────────────────────────────────────────────────────┤       │
│  │  路由层 (Handlers):                                              │       │
│  │  • /api/v1/auth/*        - 认证接口                             │       │
│  │  • /api/v1/users/*       - 用户管理                             │       │
│  │  • /api/v1/billing/*     - 计费管理                             │       │
│  │  • /api/v1/devices/*     - 设备管理                             │       │
│  │  • /api/v1/work-records/* - 工作记录                            │       │
│  │  • /api/v1/kpi/*         - KPI统计                              │       │
│  ├─────────────────────────────────────────────────────────────────┤       │
│  │  业务逻辑层 (Services):                                          │       │
│  │  • AuthService       ✅ (完全实现)                              │       │
│  │  • UserService       ✅ (完全实现)                              │       │
│  │  • BillingService    ✅ (完全实现)                              │       │
│  │  • DeviceService     ⚠️ (部分实现)                             │       │
│  │  • WorkRecordService ❌ (未实现 - TODO)                         │       │
│  │  • KpiService        ❌ (返回模拟数据)                          │       │
│  ├─────────────────────────────────────────────────────────────────┤       │
│  │  中间件层:                                                       │       │
│  │  • JWT验证中间件                                                │       │
│  │  • CORS中间件                                                   │       │
│  │  • 日志中间件                                                   │       │
│  │  • 压缩中间件                                                   │       │
│  └─────────────────────────────────────────────────────────────────┘       │
│                              ↓ ↑                                             │
│                         数据库访问 (SQLx)                                    │
│                              ↓ ↑                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                        数据层 (Data Layer)                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │                     SQLite 数据库                                │       │
│  ├─────────────────────────────────────────────────────────────────┤       │
│  │  核心表:                                                         │       │
│  │  • users            - 用户表 (三角色)                           │       │
│  │  • devices          - 设备表                                    │       │
│  │  • work_records     - 工作记录表                                │       │
│  │  • billing_records  - 计费记录表                                │       │
│  │  • company_pricing  - 公司定价表                                │       │
│  └─────────────────────────────────────────────────────────────────┘       │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                      客户端层 (Client Layer)                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │           员工客户端 (Rust + Tauri 2.0)                          │       │
│  │  原生桌面应用 (Windows)                                          │       │
│  ├─────────────────────────────────────────────────────────────────┤       │
│  │  核心模块:                                                       │       │
│  │  • AuthService          ✅ 认证服务 (与后端通信)                │       │
│  │  • AdbManager           ✅ ADB设备管理 (593行)                  │       │
│  │  • XiaohongshuAutomator ✅ 小红书自动化 (412行)                 │       │
│  │  • ContactManager       ✅ 通讯录管理                           │       │
│  │  • device.rs            ❓ 可能废弃 (与AdbManager重复)          │       │
│  │  • api.rs               ❓ 疑似未使用                           │       │
│  ├─────────────────────────────────────────────────────────────────┤       │
│  │  功能:                                                           │       │
│  │  • 设备连接管理 (最多10台)                                      │       │
│  │  • 小红书/抖音自动化操作                                        │       │
│  │  • 通讯录导入和搜索                                             │       │
│  │  • 任务执行和进度监控                                           │       │
│  └─────────────────────────────────────────────────────────────────┘       │
│                              ↓ ↑                                             │
│                        ADB Protocol                                          │
│                              ↓ ↑                                             │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │              Android设备 (手机/模拟器)                           │       │
│  │  • 小红书App                                                     │       │
│  │  • 抖音App                                                       │       │
│  └─────────────────────────────────────────────────────────────────┘       │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘

```

## 数据流示意图

### 1. 用户登录流程

```
┌─────────┐     1. 输入用户名密码      ┌──────────────┐
│ 前端UI  │ ────────────────────────> │ LoginPage    │
└─────────┘                            └──────┬───────┘
                                              │ 2. dispatch(login)
                                              ▼
                                       ┌──────────────┐
                                       │ authSlice    │
                                       └──────┬───────┘
                                              │ 3. authService.login()
                                              ▼
                  POST /api/v1/auth/login   ┌──────────────┐
                  { username, password }    │ authService  │
              ◄───────────────────────────  └──────┬───────┘
              │                                     │
              ▼                                     │
    ┌──────────────────┐                           │
    │ 后端 Handler     │                           │
    │ auth::login      │                           │
    └─────────┬────────┘                           │
              │ 4. AuthService::login()            │
              ▼                                     │
    ┌──────────────────┐                           │
    │ AuthService      │                           │
    │ • 查询用户        │                           │
    │ • 验证密码        │                           │
    │ • 生成JWT        │                           │
    └─────────┬────────┘                           │
              │ 5. 查询数据库                       │
              ▼                                     │
    ┌──────────────────┐                           │
    │ SQLite Database  │                           │
    │ users表          │                           │
    └─────────┬────────┘                           │
              │ 6. 返回用户信息                     │
              ▼                                     │
              ───────────────────────────────────> │
              { success: true, token, user }       │
                                              │     │
                                              ▼     │
                                       ┌──────────────┐
                                       │ 保存Token到  │
                                       │ localStorage │
                                       └──────┬───────┘
                                              │ 7. 更新Redux状态
                                              ▼
                                       ┌──────────────┐
                                       │ 导航到Dashboard│
                                       └──────────────┘
```

### 2. 员工客户端设备操作流程

```
┌──────────────┐     1. 点击连接设备      ┌──────────────┐
│ Tauri GUI    │ ──────────────────────> │ DeviceManager │
└──────────────┘                          └──────┬───────┘
                                                 │ 2. invoke('connect_device')
                                                 ▼
                                          ┌──────────────┐
                                          │ Rust Backend │
                                          │ (main.rs)    │
                                          └──────┬───────┘
                                                 │ 3. AdbManager::list_devices()
                                                 ▼
                                          ┌──────────────┐
                                          │ AdbManager   │
                                          │ • 执行ADB命令│
                                          │ • 解析设备信息│
                                          └──────┬───────┘
                                                 │ 4. 执行Shell命令
                                                 ▼
                                          ┌──────────────┐
                                          │ System Shell │
                                          │ adb devices  │
                                          └──────┬───────┘
                                                 │ 5. 设备列表
                                                 ▼
                                          ┌──────────────┐
                                          │ Android设备  │
                                          │ (模拟器/手机) │
                                          └──────┬───────┘
                                                 │ 6. 返回连接状态
                                                 ▼
        ┌────────────────────────────────────────────────┐
        │ 7. emit('device-connected', deviceInfo)        │
        └────────────────────────────────┬───────────────┘
                                         │ 8. 更新GUI显示
                                         ▼
                                  ┌──────────────┐
                                  │ 前端接收事件  │
                                  │ 更新设备列表  │
                                  └──────────────┘
```

### 3. 计费扣费流程

```
┌──────────────┐  1. 成功关注用户   ┌──────────────────┐
│员工客户端     │ ─────────────────> │ XiaohongshuAutomator│
└──────────────┘                     └─────────┬────────┘
                                              │ 2. 通知后端扣费
                                              ▼
                     POST /api/v1/billing/charge
                     { amount: 0.1, type: "follow" }
                              │
                              ▼
                     ┌──────────────────┐
                     │ BillingHandler   │
                     └─────────┬────────┘
                              │ 3. BillingService::charge_user()
                              ▼
                     ┌──────────────────┐
                     │ BillingService   │
                     │ • 检查余额       │
                     │ • 计算扣费       │
                     │ • 创建记录       │
                     └─────────┬────────┘
                              │ 4. 数据库事务
                              ▼
                     ┌──────────────────┐
                     │ SQLite Database  │
                     │ BEGIN TRANSACTION│
                     │ UPDATE users     │
                     │   SET balance -= │
                     │ INSERT billing   │
                     │ COMMIT           │
                     └─────────┬────────┘
                              │ 5. 返回新余额
                              ▼
                     ┌──────────────────┐
                     │ 返回响应         │
                     │ { new_balance }  │
                     └─────────┬────────┘
                              │
                              ▼
        ┌──────────────────────────────────────┐
        │ 6. 员工客户端更新本地余额显示          │
        └──────────────────────────────────────┘
```

## 模块依赖关系图

### 服务器后端模块依赖

```
                    ┌─────────────┐
                    │   main.rs   │
                    └──────┬──────┘
                           │
            ┌──────────────┼──────────────┐
            ▼              ▼              ▼
    ┌────────────┐  ┌────────────┐  ┌────────────┐
    │ server.rs  │  │ config.rs  │  │database.rs │
    │ (路由配置)  │  │ (配置加载)  │  │ (数据库)   │
    └──────┬─────┘  └────────────┘  └──────┬─────┘
           │                               │
           │ 使用                           │ 依赖
           ▼                               ▼
    ┌─────────────────────────────────────────┐
    │            Handlers                     │
    │  ┌──────┐  ┌──────┐  ┌────────┐       │
    │  │ auth │  │users │  │billing │ ...   │
    │  └───┬──┘  └───┬──┘  └────┬───┘       │
    └──────┼─────────┼──────────┼────────────┘
           │         │          │
           │ 调用     │ 调用      │ 调用
           ▼         ▼          ▼
    ┌─────────────────────────────────────────┐
    │            Services                     │
    │  ┌──────┐  ┌──────┐  ┌────────┐       │
    │  │ auth │  │user  │  │billing │ ...   │
    │  └───┬──┘  └───┬──┘  └────┬───┘       │
    └──────┼─────────┼──────────┼────────────┘
           │         │          │
           │ 查询     │ 查询      │ 查询
           └─────────┴──────────┴──────────┐
                                            ▼
                                    ┌──────────────┐
                                    │   Database   │
                                    │  (SQLite)    │
                                    └──────────────┘

✅ 低耦合: Handler只调用Service，Service调用Database
✅ 单向依赖: 上层依赖下层，下层不知道上层
```

### 服务器前端模块依赖

```
                    ┌─────────────┐
                    │   main.tsx  │
                    └──────┬──────┘
                           │
            ┌──────────────┼──────────────┐
            ▼              ▼              ▼
    ┌────────────┐  ┌────────────┐  ┌────────────┐
    │  App.tsx   │  │Redux Store │  │   Router   │
    │ (根组件)    │  │ (状态管理)  │  │  (路由)    │
    └──────┬─────┘  └──────┬─────┘  └────────────┘
           │               │
           │ 渲染           │ 订阅
           ▼               ▼
    ┌─────────────────────────────────────────┐
    │              Pages                      │
    │  ┌──────────┐  ┌──────────────────┐    │
    │  │  Login   │  │SystemAdminDashboard│  │
    │  └────┬─────┘  └────────┬─────────┘    │
    └───────┼─────────────────┼───────────────┘
            │                 │
            │ 组合             │ 组合
            ▼                 ▼
    ┌─────────────────────────────────────────┐
    │           Components                    │
    │  ┌──────┐  ┌──────┐  ┌──────┐         │
    │  │Table │  │Form  │  │Chart │ ...     │
    │  └──────┘  └──────┘  └──────┘         │
    └─────────────────────────────────────────┘
            │
            │ dispatch actions
            ▼
    ┌─────────────────────────────────────────┐
    │           Redux Slices                  │
    │  ┌──────┐  ┌──────┐  ┌──────┐         │
    │  │ auth │  │user  │  │billing│ ...    │
    │  └───┬──┘  └───┬──┘  └───┬───┘        │
    └──────┼─────────┼─────────┼─────────────┘
           │         │         │
           │ 调用     │ 调用     │ 调用
           ▼         ▼         ▼
    ┌─────────────────────────────────────────┐
    │           Services                      │
    │  ┌──────┐  ┌──────┐  ┌──────┐         │
    │  │ auth │  │user  │  │billing│ ...    │
    │  └───┬──┘  └───┬──┘  └───┬───┘        │
    └──────┼─────────┼─────────┼─────────────┘
           │         │         │
           └─────────┴─────────┴──────────────┐
                                              ▼
                                      ┌──────────────┐
                                      │   API Client │
                                      │   (axios)    │
                                      └──────────────┘

✅ 优秀的分层: UI → State → Service → API
✅ 单向数据流: 清晰的Redux数据流模式
```

### 员工客户端模块依赖

```
                    ┌─────────────┐
                    │   main.rs   │
                    │  (767行)    │
                    └──────┬──────┘
                           │
            ┌──────────────┼──────────────┬──────────────┐
            │              │              │              │
            ▼              ▼              ▼              ▼
    ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐
    │   Auth     │  │    ADB     │  │ Xiaohongshu│  │  Contact   │
    │  Service   │  │  Manager   │  │ Automator  │  │  Manager   │
    └──────┬─────┘  └──────┬─────┘  └──────┬─────┘  └────────────┘
           │               │               │
           │ HTTP API      │ ADB命令       │ 组合AdbManager
           ▼               ▼               ▼
    ┌────────────┐  ┌────────────┐  ┌────────────┐
    │  后端API    │  │   设备      │  │  小红书App  │
    └────────────┘  └────────────┘  └────────────┘

⚠️ main.rs臃肿: 包含所有Tauri命令定义
⚠️ 功能重复: device.rs与adb_manager.rs职责重叠
❓ api.rs: 疑似未使用
```

## 三角色权限模型

```
┌───────────────────────────────────────────────────────────┐
│                    系统管理员 (system_admin)                │
│  权限:                                                     │
│  ✅ 创建/管理用户管理员                                     │
│  ✅ 查看所有用户和员工                                      │
│  ✅ 设置全局收费规则                                        │
│  ✅ 系统配置和监控                                         │
│  ✅ 访问所有数据统计                                        │
└─────────────────────┬─────────────────────────────────────┘
                      │ parent_id
                      │
        ┌─────────────┴─────────────┬─────────────┐
        ▼                           ▼             ▼
┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
│ 用户管理员1      │   │ 用户管理员2      │   │ 用户管理员N      │
│(user_admin)     │   │(user_admin)     │   │(user_admin)     │
│  权限:          │   │  权限:          │   │  权限:          │
│  ✅ 创建员工     │   │  ✅ 创建员工     │   │  ✅ 创建员工     │
│   (最多10个)    │   │   (最多10个)    │   │   (最多10个)    │
│  ✅ 查看本公司   │   │  ✅ 查看本公司   │   │  ✅ 查看本公司   │
│   员工数据      │   │   员工数据      │   │   员工数据      │
│  ✅ 调整员工余额 │   │  ✅ 调整员工余额 │   │  ✅ 调整员工余额 │
│  ✅ 查看工作记录 │   │  ✅ 查看工作记录 │   │  ✅ 查看工作记录 │
└─────┬───────────┘   └─────┬───────────┘   └─────┬───────────┘
      │ parent_id           │ parent_id           │ parent_id
      │                     │                     │
   ┌──┴──┬──┬──┬──┐      ┌──┴──┬──┐           ┌──┴──┬──┐
   ▼     ▼  ▼  ▼  ▼      ▼     ▼  ▼           ▼     ▼  ▼
┌─────┐ ┌─────┐ ...   ┌─────┐ ...         ┌─────┐ ...
│员工1 │ │员工2 │       │员工1 │             │员工1 │
│(employee)│ │(employee)│ │(employee)│       │(employee)│
│权限: │ │权限: │       │权限: │             │权限: │
│✅设备│ │✅设备│       │✅设备│             │✅设备│
│✅任务│ │✅任务│       │✅任务│             │✅任务│
│✅操作│ │✅操作│       │✅操作│             │✅操作│
└─────┘ └─────┘       └─────┘             └─────┘

权限验证逻辑:
• 系统管理员: parent_id IS NULL AND role = 'system_admin'
• 用户管理员: parent_id = {系统管理员ID} AND role = 'user_admin'
• 员工: parent_id = {用户管理员ID} AND role = 'employee'
```

## 技术栈对比表

| 维度 | 服务器后端 | 服务器前端 | 员工客户端 |
|------|-----------|-----------|-----------|
| **语言** | Rust | TypeScript | Rust |
| **框架** | Axum 0.7 | React 19 | Tauri 2.0 |
| **状态管理** | 无 | Redux Toolkit | Arc<Mutex<>> |
| **数据库** | SQLite (SQLx) | 无 (API调用) | 未实现 (已配置sqlx) |
| **UI** | 无 (API服务器) | Ant Design 5 | HTML/CSS/JS |
| **HTTP客户端** | reqwest | axios | reqwest |
| **认证** | JWT (jsonwebtoken) | localStorage + Redux | JWT (本地保存) |
| **路由** | Axum Router | React Router 7 | 无 (原生应用) |
| **测试** | cargo test | Jest/Vitest | cargo test |
| **构建工具** | Cargo | Vite | Tauri CLI |
| **部署方式** | 二进制 + SQLite | 静态文件 | 桌面安装包 |

## 关键指标总结

| 指标 | 服务器后端 | 服务器前端 | 员工客户端 |
|------|-----------|-----------|-----------|
| **代码行数** | ~3000行 | ~2500行 | ~2800行 |
| **模块数量** | 15个 | 20个 | 8个 |
| **实现完成度** | 82% | 95% | 85% |
| **代码质量** | ⭐⭐⭐☆☆ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐☆ |
| **可维护性** | ⭐⭐⭐⭐☆ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐☆☆ |
| **测试覆盖率** | 0% | 0% | 0% |
| **文档完整度** | ⭐⭐⭐☆☆ | ⭐⭐☆☆☆ | ⭐⭐⭐☆☆ |

---

**说明**:
- ✅ = 已实现且正常使用
- ⚠️ = 部分实现或存在问题
- ❌ = 未实现或不可用
- ❓ = 未确认状态

此架构图基于实际代码分析生成，反映项目真实状态。
